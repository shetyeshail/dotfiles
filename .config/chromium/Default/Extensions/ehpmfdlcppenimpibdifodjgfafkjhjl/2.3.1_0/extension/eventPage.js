function checkCrawling(){if(fb.mainFriends.length>0&&fb.mainPos>=0){var e=new Date;e.getTime()-lastUpdateTime.getTime()>1e4&&getNextMutualFriend()}}function cleanData(){chrome.storage.local.clear(),fb={},fb.mainUser={},fb.mainFriends=[],fb.mainPos=0,fb.imagesFriends={},fb.mutualFriends=[],crawlingTab=null,popupTabId=null,resultingJSON={}}function getPrefixedFB(e){var n={};for(var a in fb)if(fb.hasOwnProperty(a)){if("imagesFriends"==a)continue;var r=e+"_"+a;n[r]=fb[a]}return n}function saveStatus(){var e=getPrefixedFB(fb.mainUser.userId);chrome.storage.local.set(e),chrome.storage.local.set({lastFBUserID:fb.mainUser.userId})}function loadStatus(e,n){var a=getPrefixedFB(e);a[e+"_imagesFriends"]="";var r=[];for(var t in a)r.push(t);chrome.storage.local.get(r,function(a){var r=e+"_";for(var t in a){var i=t.replace(r,"");null!=a[t]&&(fb[i]=a[t])}resultingJSON=getJSONgraphFinal(),n()})}function getNextMutualFriend(){console.log("remaining Friends to crawl: "+fb.mainPos);var e=fb.mainFriends.length-fb.mainPos;if(fb.mainPos<0||debugMode&&e>debugMaxNum)return void doneAllFriends();var n=fb.mainFriends[fb.mainPos--];if(null!=n.userName&&"profile.php"!=n.userName){console.log("f: "+n.userName);var a=getFriendsPage(n.id);console.log(a),saveStatus(),null==crawlingTab?chrome.windows.create({type:"popup",url:a,width:100,height:100},function(e){crawlingTab=e.tabs[0].id}):chrome.tabs.update(crawlingTab,{url:a},function(e){})}else getNextMutualFriend()}function gotImage(e){fb.imagesFriends[e.id]=e.dataUrl;var n=Object.keys(fb.imagesFriends).length;if(n==fb.mainFriends.length-1){var a={},r=fb.mainUser.userId+"_imagesFriends";a[r]=fb.imagesFriends,chrome.storage.local.set(a)}}var debugMode=!1,debugMaxNum=5,fb={};fb.mainUser={},fb.mainFriends=[],fb.mainPos=0,fb.imagesFriends={},fb.mutualFriends=[];var resultingJSON={},crawlingTab,popupTabId,getCrawlingPercentage=function(){var e=fb.mainFriends.length-1,n=(e-(fb.mainPos+1))/e;return n},getCurrentAction=function(){return fb.mainPos<=0&&fb.mainUser=={}?"checking user":fb.mainPos<=0?"done":fb.mainPos>0?"loading friends":"dunno"},getCurrentStatus=function(){return"unused"},gotMainFriends=function(e){console.log(e),fb.mainUser.userId=e.userID,fb.mainUser.userName=e.userName,fb.mainFriends=e.friends,fb.mainPos=fb.mainFriends.length-1;var n=JSON.parse(JSON.stringify(e));fb.mutualFriends.push(n),console.log("got mainFriends: "+e.friends.length),saveStatus(),getNextMutualFriend()},getJSONgraphFinal=function(){var e=[],n=[],a=fb.mutualFriends[0];if(void 0==fb.mainUser.userId)return null;a.userID=fb.mainUser.userId,a.userName=fb.mainUser.userName;for(var r=0,t={},i=0;i<a.friends.length;i++){var s=a.friends[i];t[s.id]=r++,s.dataUrl=fb.imagesFriends[s.id],e.push(s)}for(var i=1;i<fb.mutualFriends.length;i++){var o=fb.mutualFriends[i];o.id=o.userID;for(var u=o.friends,d=0;d<u.length;d++){var l=u[d];console.log(o.id+"\t"+l.id),o.id in t||(e.push(o),t[o.id]=r++),l.id in t||(e.push(l),t[l.id]=r++);var f=t[o.id],c=t[l.id];n.push({source:f,target:c})}}var g={userId:a.userID,userName:a.userName,nodes:e,links:n};return g},loadDataIfNeeded=function(){void 0==fb.mainUser.userId&&getFacebookIDloggedIn(function(e){null!=e?loadStatus(e,function(){}):(alert("Please login in facebook.com and try again."),chrome.tabs.create({url:"https://www.facebook.com/"}))})},convertCurrentNetworkData=function(){var e=getJSONgraphFinal();resultingJSON=e},doneAllFriends=function(){convertCurrentNetworkData(),chrome.tabs.sendMessage(mainTabId,resultingJSON,function(e){}),"undefined"!=typeof crawlingTab&&"undefined"!=typeof crawlingTab.id&&chrome.windows.remove(crawlingTab.id)};chrome.tabs.onRemoved.addListener(function(e,n){crawlingTab==e&&(crawlingTab=null)});var lastUpdateTime=new Date;chrome.runtime.onMessage.addListener(function(e,n,a){return"mainFriends"==e.type?(mainTabId=n.tab.id,gotMainFriends(e)):"mutualFriends"==e.type?(fb.mutualFriends.push(e),lastUpdateTime=new Date,getNextMutualFriend()):"image"==e.type?gotImage(e):"loadStatus"==e.type?loadStatus(e.id,function(){var e=a;fb.mainFriends.length>1?(e({status:"friendsLoaded"}),fb.mainPos>=0?getNextMutualFriend():doneAllFriends()):e({status:"friendsNotLoaded"})}):"setMainTab"==e.type?mainTabId=n.tab.id:"percentage"==e.subject?a({value:getCrawlingPercentage(),action:getCurrentAction(),status:getCurrentStatus()}):"deleteData"!=e.subject&&"clearData"!=e.subject||cleanData(),!0}),setInterval(checkCrawling,1e4);var getFacebookIDloggedIn=function(e){$.ajax({url:"https://www.facebook.com",success:function(n){var a=n,r=/profile_pic_header_([0-9]+)/.exec(a)[1];e(void 0==r?null:r)}})},getFriendsPage=function(e){var n=fb.mainUser.userId,a="https://www.facebook.com/browse/mutual_friends/?uid="+n+"&node="+e;return a};chrome.runtime.onMessage.addListener(function(e,n,a){"getNetwork"===e.type||"grabData"===e.subject?(convertCurrentNetworkData(),a(resultingJSON)):"startLoading"==e.type&&getFacebookIDloggedIn(function(e){null!=e?chrome.tabs.create({url:"https://www.facebook.com/profile.php?id="+e+"&sk=friends&source_ref=pb_friends_tl"}):(alert("Please login in facebook.com and try again."),chrome.tabs.create({url:"https://www.facebook.com/"}))})}),loadDataIfNeeded();