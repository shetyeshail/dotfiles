document.environment="https://refind.com";(function(){var e,j,g,c,i,b,l,k,f,d,a,h;d=function(m){this.typeahead||(this.typeahead=new window.TagTypeahead(1));return this.typeahead.setup(m||".tags-container .tags .tag-form > .tag-input");};l=function(n){var m;if(n==null){n=document.body;}m=$(n);m.on("mouseenter",".tag",function(){return $(this).addClass("expanded");});m.on("focusin",".tag-input",function(){var o;o=$(this);return e(o.parents(".tag-form"));});m.on("focusout",".tag-input",function(){var o,p;o=$(this);if(typeof Helpers!=="undefined"&&Helpers!==null){p=Helpers.getLink(o);if(p.hasClass("rv")){return;}}o=$(this);if(o.val().length===0){return b(o.parents(".tag-form"));}});m.on("keydown",".tag-input",function(p){var o;o=$(this);o.change();if(p.keyCode===13){o.parents(".tag-form").submit();return false;}});m.on("typeahead:select",".tag-input",function(q,o){var p,r;r=$(q.currentTarget);p=r.parents("form");return a(p);});m.on("submit",".tag-form",function(o){a($(this));return false;});return m.on("click",".remove-tag",function(p){var q,t,s,o,r;p.preventDefault();q=$(this);t=q.parents("[data-link-id]");s=t.data("link-id");o=q.parents(".tag");r=o[0].querySelector("a").innerHTML;o.remove();return $.ajax({url:(document.environment||"")+"/api/link/tag/remove.json",type:"POST",dataType:"json",data:{link_id:s,text:r,client:"/api/link/tag/remove"},success:function(u){if(u.valid){return $(".link[data-link-id="+s+"]").each(function(){var w,v;w=$(this);if(!w.is(t)){v=w.find(".tag a:contains("+r+")");if(v.length>0){return v.filter(function(){return $(this).text()===r;}).each(function(x){return $(x).parent().remove();});}}});}}});});};e=function(m){m.find(".tag-input").attr("placeholder","Add tagâ€¦");return m.addClass("activated");};b=function(m){m.find(".tag-input").attr("placeholder","Tag");return m.removeClass("activated");};h=function(m){return m.parent(".tags").find(".tags-list");};c=function(p,o){var m,n,q;if(o==null){o=true;}m=document.createElement("div");m.classList.add("tag");n=document.createElement("a");n.setAttribute("href",(document.environment||"")+("/hashtags/"+p));n.setAttribute("target","_blank");n.classList.add("anchor-action");q=document.createTextNode(p);n.appendChild(q);m.appendChild(n);if(o){m.appendChild(i());m.classList.add("expanded");}return m;};i=function(){var m,n;m=document.createElement("i");m.classList.add("fa");m.classList.add("fa-close");n=document.createElement("a");n.classList.add("remove-tag");n.setAttribute("rel","nofollow");n.setAttribute("title","Remove");n.appendChild(m);return n;};f=function(o,n){var m;m=false;o.querySelectorAll(".tag").forEach(function(p){if(p.querySelector("a").innerHTML===n){return m=p;}});if(m){return m;}};g=function(o,n){var m;m=/[,;]/;return n.split(m).forEach(function(p){var q;if(!(q=f(o,p))){return j(o,p);}});};j=function(q,p,o){var n,m;if(o==null){o=true;}if(p===""){return;}n=f(q,p);if(n){return;}m=c(p,o);q.appendChild(m);return m;};k=function(m){return m.typeahead("val","");};a=function(o){var n,r,m,q,p;n=o.find(".tag-input.tt-input").last();p=n.typeahead("val");if(!(p&&p.length>0)){return;}q=h(o)[0];g(q,p);k(n);m=n.parents("[data-link-id]");r=m.data("link-id");return $.ajax({url:(document.environment||"")+"/api/link/tag/save.json",type:"POST",dataType:"json",data:{link_id:r,text:p,client:"/api/link/tag/save"},success:function(s){if(s.valid){return $(".link[data-link-id="+r+"]").each(function(){var t;t=$(this);if(!t.is(m)){o=t.find(".tags-container form.tag-form");q=h(o)[0];return g(q,p);}});}}});};window.tagsSetup=d;window.tagsInstallEventHandlers=l;window.tagsSubmitForm=a;window.tagsAppendTag=j;window.tagsActivate=e;window.tagsInstallEventHandlers();}).call(this);(function(){var API,Browser,BrowserAdapter,Google,Popover,Refind,Results,Settings,Toolbar,URLs,bind=function(fn,me){return function(){return fn.apply(me,arguments);};},indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item){return i;}}return -1;};window.Browser=Browser=(function(){function Browser(url1){this.url=url1;this.broadcast=bind(this.broadcast,this);this.sendFromPopover=bind(this.sendFromPopover,this);this.send=bind(this.send,this);this.on=bind(this.on,this);this.updateCheck=bind(this.updateCheck,this);this.getClientVersion=bind(this.getClientVersion,this);this.askCurrentToolbarShown=bind(this.askCurrentToolbarShown,this);this.getCurrentSelection=bind(this.getCurrentSelection,this);this.getCurrentFaviconURL=bind(this.getCurrentFaviconURL,this);this.getCurrentTitle=bind(this.getCurrentTitle,this);this.getCurrentURL=bind(this.getCurrentURL,this);this.setupPopover=bind(this.setupPopover,this);this.setupInserts=bind(this.setupInserts,this);this.setupSearchEngine=bind(this.setupSearchEngine,this);this.setupBackground=bind(this.setupBackground,this);this.refindInstanceFrom=bind(this.refindInstanceFrom,this);this.id="chrome";this.runtime=chrome.runtime;this.messageMapping={};this.reload=chrome.runtime.reload;this.resizePopoverTimeoutDuration=300;}Browser.prototype.refindInstanceFrom=function(refind,env){return new Refind(env);};Browser.prototype.setupBackground=function(refind){refind.setupAPIListeners(false);refind.setupBackgroundSearchListeners(false);return refind.setupBackgroundInsertListeners(false);};Browser.prototype.setupSearchEngine=function(refind,engine){return refind.setupSearchListeners(engine,false);};Browser.prototype.setupInserts=function(refind,engine){return refind.setupInsertListeners(engine,false);};Browser.prototype.setupPopover=function(refind,popover,api,browser_adapter){refind.setupPopoverListeners(popover);return popover.initial();};Browser.prototype.resizePopover=function(document){clearTimeout(this.resizePopoverTimeoutId);return this.resizePopoverTimeoutId=setTimeout(function(){return document.querySelectorAll(".dialog").forEach(function(d){var bgc,box;if(d.style.display==="block"){box=d.querySelector(".box");bgc=window.getComputedStyle(box).backgroundColor;document.querySelector("body").style.borderTop="1px solid "+bgc;return document.querySelector("body").style.borderBottom="1px solid "+bgc;}});},this.resizePopoverTimeoutDuration);};Browser.prototype.hidePopover=function(popover){};Browser.prototype.isPrivate=function(){return false;};Browser.prototype.canHighlight=function(){return true;};Browser.prototype.getCurrentURL=function(callback){return this.withCurrentTab(function(tab){return callback(tab.url);});};Browser.prototype.getCurrentTitle=function(callback){return this.withCurrentTab(function(tab){return callback(tab.title);});};Browser.prototype.getCurrentFaviconURL=function(callback){return this.withCurrentTab(function(tab){return callback(tab.favIconUrl);});};Browser.prototype.getCurrentSelection=function(callback){return this.withCurrentTab(function(tab){return chrome.tabs.executeScript({code:"window.getSelection().toString();"},function(selection){return callback(selection[0]);});});};Browser.prototype.askCurrentToolbarShown=function(popover){return this.withCurrentTab((function(_this){return function(tab){return _this.send("toolbar_shown",{},tab);};})(this));};Browser.prototype.getClientName=function(){return"chrome";};Browser.prototype.getClientVersion=function(callback){return callback(this.runtime.getManifest().version);};Browser.prototype.openURL=function(url){return chrome.tabs.create({url:url});};Browser.prototype.updateCheck=function(callback){return this.runtime.requestUpdateCheck(function(status){if(status==="update_available"){return callback();}});};Browser.prototype.on=function(id,local){return this.runtime.onMessage.addListener((function(_this){return function(data,sender,response){if(data.messageId===id){delete data.messageId;if(sender.tab!=null){local(data,sender.tab);}else{if(response!=null){local(data,response);}else{local(data);}}return true;}};})(this));};Browser.prototype.send=function(id,data,tab){data||(data={});data.messageId=id;if(tab!=null?tab.id:void 0){return chrome.tabs.sendMessage(tab.id,data);}else{return chrome.runtime.sendMessage(data);}};Browser.prototype.sendFromPopover=function(id,data,callback){data||(data={});data.messageId=id;return chrome.runtime.sendMessage(data,callback);};Browser.prototype.broadcast=function(id,data){data||(data={});data.messageId=id;return chrome.tabs.query({},function(tabs){var i,len,results1,tab;results1=[];for(i=0,len=tabs.length;i<len;i++){tab=tabs[i];results1.push(chrome.tabs.sendMessage(tab.id,data));}return results1;});};Browser.prototype.withCurrentTab=function(callback){return chrome.tabs.query({active:true,currentWindow:true},function(tabs){return callback(tabs[0]);});};Browser.prototype.cachePopupDom=function(){return false;};Browser.prototype.debug=function(){return console.debug.apply(console,arguments);};return Browser;})();Settings=Settings=(function(){function Settings(api1,browser1){this.api=api1;this.browser=browser1;this.modifyDomainBlacklist=bind(this.modifyDomainBlacklist,this);this.fetchToolbar=bind(this.fetchToolbar,this);this.fetchIfNeeded=bind(this.fetchIfNeeded,this);this.sendSettings=bind(this.sendSettings,this);this.broadcastSettings=bind(this.broadcastSettings,this);this.setToolbarSessionEnabled=bind(this.setToolbarSessionEnabled,this);this.setToolbarDomainBlacklist=bind(this.setToolbarDomainBlacklist,this);this.setToolbarEnabled=bind(this.setToolbarEnabled,this);this.invalidate=bind(this.invalidate,this);this.fetch=bind(this.fetch,this);this.reset=bind(this.reset,this);this.reset();}Settings.prototype.reset=function(){this.loaded=false;this.searchAllowed=false;this.defaultAction=false;this.groups=[];this.groupsEtag=0;this.toolbarLoaded=false;this.toolbarEnabled=false;this.toolbarSessionEnabled=true;this.toolbarDomainBlacklist=[];return this.toolbarGlobalModifications=[];};Settings.prototype.fetch=function(callback){return this.api.getSettings({toolbar_global_modifications:true},(function(_this){return function(response){_this.loaded=true;_this.searchAllowed=response.search_setting;_this.defaultAction=response.default_action;_this.groups=response.groups;_this.groupsEtag=response.groups_etag;_this.toolbarEnabled=response.toolbar_enabled;_this.toolbarDomainBlacklist=response.toolbar_domain_blacklist;_this.toolbarGlobalModifications=response.toolbar_global_modifications;_this.broadcastSettings();return callback&&callback(_this);};})(this));};Settings.prototype.invalidate=function(groups_etag,callback){this.groupsEtag=groups_etag;return this.fetch(callback);};Settings.prototype.setToolbarEnabled=function(enabled,force){if(force==null){force=false;}this.toolbarEnabled=enabled;return this.broadcastSettings(force);};Settings.prototype.setToolbarDomainBlacklist=function(list){this.toolbarDomainBlacklist=list;return this.broadcastSettings();};Settings.prototype.setToolbarSessionEnabled=function(enabled){this.toolbarSessionEnabled=enabled;return this.broadcastSettings();};Settings.prototype.broadcastSettings=function(force){var data;if(force==null){force=false;}data={enabled:this.toolbarEnabled,session_enabled:this.toolbarSessionEnabled,domain_blacklist:this.toolbarDomainBlacklist,global_modifications:this.toolbarGlobalModifications};if(force){data.force=true;}return this.browser.broadcast("settings_toolbar_enabled_results",data);};Settings.prototype.sendSettings=function(thing,browser){var data;data={enabled:this.toolbarEnabled,session_enabled:this.toolbarSessionEnabled,domain_blacklist:this.toolbarDomainBlacklist,global_modifications:this.toolbarGlobalModifications};return(browser||this.browser).send("settings_toolbar_enabled_results",data,thing);};Settings.prototype.fetchIfNeeded=function(callback){if(this.loaded){return callback(this);}else{return this.fetch(callback);}};Settings.prototype.fetchToolbar=function(callback){if(this.toolbarLoaded){return callback(this.toolbar);}else{return this.api.getToolbar({},(function(_this){return function(response){_this.toolbarLoaded=true;_this.toolbar={html:response};return callback(_this.toolbar);};})(this));}};Settings.prototype.modifyDomainBlacklist=function(domain,add){var index;index=this.toolbarDomainBlacklist.indexOf(domain);if(add){if(index<0){this.toolbarDomainBlacklist.push(domain);}}else{if(index>=0){this.toolbarDomainBlacklist.splice(index,1);}}return this.broadcastSettings();};return Settings;})();window.SearchEngines={};window.SearchEngines.Google=Google=(function(){var adaptiveWaitTime,lastQuery,maxAdaptiveWaitTime;function Google(browser1){this.browser=browser1;this.renderResults=bind(this.renderResults,this);this.withResultURLs=bind(this.withResultURLs,this);this.maybeSearch=bind(this.maybeSearch,this);this.setupResultsObserver=bind(this.setupResultsObserver,this);this.setupObserver=bind(this.setupObserver,this);this.setup=bind(this.setup,this);this.results=new Results(this.browser);}Google.prototype.isApplicable=function(url){return/http(?:s)?:\/\/(?:([a-zA-Z0-9]+)[.])?(google)/.test(url);};Google.prototype.setup=function(refind){this.browser.setupSearchEngine(refind,this);return this.setupObserver();};Google.prototype.setupObserver=function(){return this.setupResultsObserver();};adaptiveWaitTime=100;maxAdaptiveWaitTime=1000;Google.prototype.setupResultsObserver=function(){var error,searchObserver,searchTarget;if(searchTarget=document.querySelector("#search")){if(this.resultsObserverSetup!=null){return;}this.resultsObserverSetup=true;if($(searchTarget).find("div.g").length>0){this.maybeSearch();}searchObserver=new MutationObserver((function(_this){return function(mutations){return _this.maybeSearch();};})(this));try{return searchObserver.observe(searchTarget,{childList:true});}catch(error1){error=error1;}}else{setTimeout(this.setupResultsObserver,adaptiveWaitTime);adaptiveWaitTime*=2;if(adaptiveWaitTime>maxAdaptiveWaitTime){return adaptiveWaitTime=maxAdaptiveWaitTime;}}};lastQuery="";Google.prototype.maybeSearch=function(){return this.withQuery((function(_this){return function(query){if(lastQuery===query){_this.clearLastQuery();}else{lastQuery=query;return _this.withResultURLs(function(resultURLs){return _this.browser.send("maybe_search",{search_engine:"google",query:query,result_urls:resultURLs});});}};})(this));};Google.prototype.clearLastQuery=function(){return setTimeout((function(){return lastQuery="";}),500);};Google.prototype.withResultURLs=function(callback){return setTimeout((function(_this){return function(){var resultURLs;resultURLs=_this.results.getURLs();if(resultURLs.length===0){return _this.withResultURLs(callback);}else{return callback(resultURLs);}};})(this),50);};Google.prototype.withQuery=function(callback){var input,query;input=$('input[type="text"]');if(input&&input.length>0){query=input.val();return callback(encodeURIComponent(query));}};Google.prototype.renderResults=function(response){if(response){return this.results.render(response);}};return Google;})();Results=(function(){function Results(browser1){this.browser=browser1;this.createInteractionCountElement=bind(this.createInteractionCountElement,this);this.createSaveCountElement=bind(this.createSaveCountElement,this);this.createDecorationElement=bind(this.createDecorationElement,this);this.createResultElement=bind(this.createResultElement,this);this.decorate=bind(this.decorate,this);this.createRefindResult=bind(this.createRefindResult,this);this.inject=bind(this.inject,this);this.render=bind(this.render,this);}Results.prototype.getURLs=function(){var i,len,link,result,results,results1,url;results=document.getElementsByClassName("r");results1=[];for(i=0,len=results.length;i<len;i++){result=results[i];link=result.getElementsByTagName("a");if(link&&(link.id==null)){url=link[0];results1.push(encodeURIComponent(url));}else{results1.push(void 0);}}return results1;};Results.prototype.render=function(payload){if(payload.results){if(payload.decorations&&Object.keys(payload.decorations).length>0){this.decorate(payload.decorations);}if(payload.refind_result){return this.inject(payload.refind_result,payload.position);}}};Results.prototype.inject=function(refind_result,refind_result_position){var position,previousInjection,refindResult,result,resultArea,results,resultsWrapper,target;resultArea=document.getElementById("rso");if(resultArea){resultsWrapper=resultArea.getElementsByClassName("srg");if(resultsWrapper){target=resultsWrapper[0];if(target.firstChild){results=target.getElementsByClassName("g");if(results){position=Math.min(refind_result_position,results.length);result=results[position];refindResult=this.createRefindResult(refind_result);previousInjection=$("div.refind-injected-result");if(previousInjection.length>0){return previousInjection.replaceWith(refindResult);}else{return target.insertBefore(refindResult,result);}}}}}};Results.prototype.createRefindResult=function(refind_result){var refindResult;refindResult=document.createElement("div");refindResult.className="g refind-injected-result";refindResult.appendChild(this.createResultElement(refind_result));return refindResult;};Results.prototype.decorate=function(decorations){var decorationData,header,i,len,newDecoration,previousDecoration,result,results,results1,url;results=document.getElementsByClassName("rc");results1=[];for(i=0,len=results.length;i<len;i++){result=results[i];header=result.getElementsByClassName("r")[0];url=header.getElementsByTagName("a")[0].toString();if(decorationData=decorations[url]){newDecoration=document.createElement("div");newDecoration.className="refind-injected-decoration";newDecoration.appendChild(this.createDecorationElement(decorationData));previousDecoration=$(result).find("div.refind-injected-decoration");if(previousDecoration.length>0){results1.push(previousDecoration.replaceWith(newDecoration));}else{results1.push(result.appendChild(newDecoration));}}else{results1.push(void 0);}}return results1;};Results.prototype.createResultElement=function(data){var cite,div,fDiv,header,headerLink,headerLinkText,sChildDiv,sDiv,slpDiv,span,spanChild;div=document.createElement("div");div.classList.add("rc");div.setAttribute("style","background-color: #f5f8fa; border-right: 4px solid #1492ef; overflow-x: hidden; padding-right: 5px;");header=document.createElement("h3");header.classList.add("r");headerLink=document.createElement("a");headerLink.setAttribute("id","refind-result");headerLink.setAttribute("href",data.url);headerLinkText=document.createTextNode(data.title);headerLink.appendChild(headerLinkText);header.appendChild(headerLink);div.appendChild(header);sDiv=document.createElement("div");sDiv.classList.add("s");sChildDiv=document.createElement("div");sDiv.appendChild(sChildDiv);fDiv=document.createElement("div");fDiv.classList.add("f");fDiv.classList.add("kv");fDiv.classList.add("_SWb");fDiv.setAttribute("style","white-space:nowrap");cite=document.createElement("cite");cite.classList.add("_Rm");cite.innerHTML=data.short_url;fDiv.appendChild(cite);sChildDiv.appendChild(fDiv);slpDiv=document.createElement("div");slpDiv.classList.add("f");slpDiv.classList.add("slp");sChildDiv.appendChild(slpDiv);span=document.createElement("span");span.classList.add("st");spanChild=document.createElement("f");span.appendChild(spanChild);span.appendChild(this.createDecorationElement(data.decoration));sChildDiv.appendChild(span);div.appendChild(sDiv);return div;};Results.prototype.createDecorationElement=function(data){var div,friend,friendLink,i,img,infoDiv,interactionCountLink,len,moreLink,moreLinkText,ref;div=document.createElement("div");div.setAttribute("style","margin-top: 3px;");infoDiv=document.createElement("div");infoDiv.setAttribute("style","display: inline-block; vertical-align: top; position: relative; top: 3px;");interactionCountLink=null;if(data.friends.length>0){ref=data.friends;for(i=0,len=ref.length;i<len;i++){friend=ref[i];friendLink=document.createElement("a");friendLink.setAttribute("href",friend.href);friendLink.setAttribute("target","_blank");img=document.createElement("img");img.setAttribute("src",friend.image_url);img.setAttribute("style","width: 22px; height: 22px; margin-right: 3px; -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%;");friendLink.appendChild(img);div.appendChild(friendLink);}if(data.interaction_count>0){interactionCountLink=this.createInteractionCountElement(data,""+data.interaction_count);}}else{if(data.interaction_count>0){interactionCountLink=this.createSaveCountElement(data,data.interaction_count_text);}}if(interactionCountLink){infoDiv.appendChild(interactionCountLink);infoDiv.appendChild(document.createTextNode("\u00A0\u00B7\u00A0"));}moreLink=document.createElement("a");moreLink.setAttribute("id","refind-more");moreLink.setAttribute("href",data.more_url);moreLinkText=document.createTextNode("View similar links");moreLink.appendChild(moreLinkText);infoDiv.appendChild(moreLink);div.appendChild(infoDiv);return div;};Results.prototype.createSaveCountElement=function(data,text){var countLink,countText;countLink=document.createElement("a");countLink.setAttribute("href",data.link_url);countText=document.createTextNode(text);countLink.appendChild(countText);return countLink;};Results.prototype.createInteractionCountElement=function(data,text){var interactionCountLink,interactionCountText;interactionCountLink=document.createElement("a");interactionCountLink.setAttribute("href",data.link_url);interactionCountLink.style.marginLeft="4px";interactionCountText=document.createTextNode(text);interactionCountLink.appendChild(interactionCountText);return interactionCountLink;};return Results;})();window.Toolbar={};window.Toolbar=Toolbar=(function(){function Toolbar(browser1,height,positionTop){this.browser=browser1;this.height=height;this.positionTop=positionTop;this.domain=bind(this.domain,this);this.closeForever=bind(this.closeForever,this);this.closeDomain=bind(this.closeDomain,this);this.closeSession=bind(this.closeSession,this);this.removeModifications=bind(this.removeModifications,this);this.applyModifications=bind(this.applyModifications,this);this.showSettings=bind(this.showSettings,this);this.hide=bind(this.hide,this);this.close=bind(this.close,this);this.show=bind(this.show,this);this.anchor=bind(this.anchor,this);this.more=bind(this.more,this);this.send=bind(this.send,this);this.random=bind(this.random,this);this.extra=bind(this.extra,this);this.read=bind(this.read,this);this.save=bind(this.save,this);this.stopSpin=bind(this.stopSpin,this);this.startSpin=bind(this.startSpin,this);this.apiCallResults=bind(this.apiCallResults,this);this.installElements=bind(this.installElements,this);this.installHooks=bind(this.installHooks,this);this.installHistoryHooks=bind(this.installHistoryHooks,this);this.startUrlCheck=bind(this.startUrlCheck,this);this.urlChanged=bind(this.urlChanged,this);this.checkForChangedUserId=bind(this.checkForChangedUserId,this);this.userIdChanged=bind(this.userIdChanged,this);this.toolbarData=bind(this.toolbarData,this);this.toolbarElement=bind(this.toolbarElement,this);this.whenLoaded=bind(this.whenLoaded,this);this.setExtra=bind(this.setExtra,this);this.setMore=bind(this.setMore,this);this.setSend=bind(this.setSend,this);this.setAudioUrl=bind(this.setAudioUrl,this);this.setSummaryUrl=bind(this.setSummaryUrl,this);this.setComments=bind(this.setComments,this);this.setInteractionCount=bind(this.setInteractionCount,this);this.setSavers=bind(this.setSavers,this);this.clearMiddle=bind(this.clearMiddle,this);this.setArchived=bind(this.setArchived,this);this.setStarred=bind(this.setStarred,this);this.setSaved=bind(this.setSaved,this);this.setLinkId=bind(this.setLinkId,this);this.isEnabled=bind(this.isEnabled,this);this.setSettings=bind(this.setSettings,this);this.setupFrame=bind(this.setupFrame,this);this.toolbarHTML=bind(this.toolbarHTML,this);this.executeBeforeLoaded=bind(this.executeBeforeLoaded,this);this.askForData=bind(this.askForData,this);this.resetSettings=bind(this.resetSettings,this);this.setupCommunication=bind(this.setupCommunication,this);this.onFrameExists=bind(this.onFrameExists,this);this.insertFrame=bind(this.insertFrame,this);this.setupStructure=bind(this.setupStructure,this);this.setup=bind(this.setup,this);this.cacheHref=bind(this.cacheHref,this);this.location=document.location;this.cacheHref();this.iframeId="refind-toolbar-iframe";this.loaded=false;this.beforeLoaded=[];this.enabled=false;this.sessionEnabled=true;this.initialUserId=-1;this.userId=this.initialUserId;this.spaBlacklist=[];}Toolbar.prototype.cacheHref=function(){return this.href=this.location.href;};Toolbar.prototype.setup=function(refind){this.setupStructure();return this.setupCommunication(refind);};Toolbar.prototype.setupStructure=function(){return this.shown=false;};Toolbar.prototype.insertFrame=function(){var iframe;iframe=document.createElement("iframe");iframe.id=this.iframeId;iframe.style.backgroundColor="#333333";iframe.style.width="100%";iframe.style.position="fixed";iframe.style.margin="0";if(this.top){iframe.style.top="0";}else{iframe.style.bottom="0";}iframe.style.left="0";iframe.style.zIndex="2000000000";iframe.style.borderWidth="0px";iframe.style.borderStyle="none";iframe.style.height=this.height;iframe.style.minHeight="0";iframe.style.maxHeight="0";iframe.style.transition="max-height 0.2s ease-in";return this.iframe=document.documentElement.appendChild(iframe);};Toolbar.prototype.onFrameExists=function(event){this.loaded=true;this.installElements(event);this.executeBeforeLoaded(event);this.installHooks(event);if(document.readyState==="loading"){return document.addEventListener("load",this.installHistoryHooks);}else{return this.installHistoryHooks();}};Toolbar.prototype.setupCommunication=function(refind){this.browser.setupInserts(refind,this);this.browser.send("maybe_toolbar",{});return this.browser.send("settings_toolbar_enabled",{});};Toolbar.prototype.resetSettings=function(){return this.browser.send("reset_settings");};Toolbar.prototype.askForData=function(href,force){var extra;if(force==null){force=false;}extra={refind_url:true,share_url:true,savers:true,saved_count:true,interaction_count:true,comment_count:true,comment_url:true,summary_url:true,extra_type:true,extra_url:true,audio_url:true,toolbar_modifications:true};extra.toolbar_condition=!force;return this.browser.send("maybe_link_data",{origin:"toolbar",url:href,extra:extra});};Toolbar.prototype.executeBeforeLoaded=function(){var func,i,len,ref,results1;ref=this.beforeLoaded;results1=[];for(i=0,len=ref.length;i<len;i++){func=ref[i];results1.push(func());}return results1;};Toolbar.prototype.toolbarHTML=function(html){return this.html=html;};Toolbar.prototype.setupFrame=function(){this.iframe.onload=this.onFrameExists;return this.iframe.srcdoc=this.html;};Toolbar.prototype.setSettings=function(data){var blacklist,enabled,force,sessionEnabled;force=data.force;enabled=data.enabled;sessionEnabled=data.session_enabled;blacklist=data.domain_blacklist;this.globalModifications=data.global_modifications;if(this.isEnabled(this.enabled,this.sessionEnabled,this.domainBlacklist,this.spaBlacklist)){if(!this.isEnabled(enabled,sessionEnabled,blacklist)){this.close();}}if(this.dataAvailable){if(!this.isEnabled(this.enabled,this.sessionEnabled,this.domainBlacklist,this.spaBlacklist)){if(this.isEnabled(enabled,sessionEnabled,blacklist)){this.show();}}}this.enabled=enabled;this.sessionEnabled=sessionEnabled;this.domainBlacklist=blacklist;if(!(!force&&this.settingsReceivedOnce)){if(force||this.isEnabled(this.enabled,this.sessionEnabled,this.domainBlacklist)){this.askForData(this.location.href,force);}return this.settingsReceivedOnce=true;}};Toolbar.prototype.isEnabled=function(enabled,sessionEnabled,blacklist,spaBlacklist){var domain;if(spaBlacklist==null){spaBlacklist=[];}if(!blacklist){return false;}domain=this.domain();return enabled&&sessionEnabled&&indexOf.call(blacklist,domain)<0&&indexOf.call(spaBlacklist,domain)<0;};Toolbar.prototype.setLinkId=function(id){return this.linkId=id;};Toolbar.prototype.setSaved=function(saved){this.saved=saved;return this.whenLoaded((function(_this){return function(){if(_this.saved){return _this.toolbarElement().classList.add("saved");}else{return _this.toolbarElement().classList.remove("saved");}};})(this));};Toolbar.prototype.setStarred=function(starred){this.starred=starred;return this.whenLoaded((function(_this){return function(){if(_this.starred){return _this.toolbarElement().classList.add("starred");}else{return _this.toolbarElement().classList.remove("starred");}};})(this));};Toolbar.prototype.setArchived=function(archived){this.archived=archived;return this.whenLoaded((function(_this){return function(){if(_this.archived){return _this.toolbarElement().classList.add("archived");}else{return _this.toolbarElement().classList.remove("archived");}};})(this));};Toolbar.prototype.clearMiddle=function(){return this.whenLoaded((function(_this){return function(){var child,middle,results1;middle=_this.toolbarElement().querySelector(".middle");results1=[];while(child=middle.firstChild){results1.push(middle.removeChild(child));}return results1;};})(this));};Toolbar.prototype.setSavers=function(savers){this.savers=savers;return this.whenLoaded((function(_this){return function(){var a,i,img,len,middle,ref,results1,saver;if(_this.savers){middle=_this.toolbarElement().querySelector(".middle");ref=_this.savers;results1=[];for(i=0,len=ref.length;i<len;i++){saver=ref[i];a=_this.anchor(saver.refind_url);img=document.createElement("img");img.classList.add("face");img.src=saver.image_url;a.appendChild(img);results1.push(middle.appendChild(a));}return results1;}};})(this));};Toolbar.prototype.setInteractionCount=function(interactionCount,interactionCountText){this.interactionCount=interactionCount;this.interactionCountText=interactionCountText;return this.whenLoaded((function(_this){return function(){var a,item,middle,text;if(_this.interactionCount&&_this.interactionCount>0&&_this.interactionCountText){middle=_this.toolbarElement().querySelector(".middle");item=document.createElement("div");item.classList.add("item");a=document.createElement("a");a=_this.anchor(_this.refindUrl);text=document.createTextNode(_this.interactionCountText);a.appendChild(text);item.appendChild(a);return middle.appendChild(item);}};})(this));};Toolbar.prototype.setComments=function(commentUrl,commentCount,commentCountText){this.commentUrl=commentUrl;this.commentCount=commentCount;this.commentCountText=commentCountText;return this.whenLoaded((function(_this){return function(){var a,item,middle,text;if(_this.commentCount&&_this.commentCount>0&&_this.commentCountText&&_this.commentUrl){middle=_this.toolbarElement().querySelector(".middle");item=document.createElement("div");item.classList.add("item");item.classList.add("emphasized");a=_this.anchor(_this.commentUrl);text=document.createTextNode(_this.commentCountText);a.appendChild(text);item.appendChild(a);return middle.appendChild(item);}};})(this));};Toolbar.prototype.setSummaryUrl=function(summaryUrl){this.summaryUrl=summaryUrl;return this.whenLoaded((function(_this){return function(){var a,item,middle,text;if(_this.summaryUrl){middle=_this.toolbarElement().querySelector(".middle");item=document.createElement("div");item.classList.add("item");item.classList.add("emphasized");a=_this.anchor(_this.summaryUrl);text=document.createTextNode("Summary");a.appendChild(text);item.appendChild(a);return middle.appendChild(item);}};})(this));};Toolbar.prototype.setAudioUrl=function(audioUrl){this.audioUrl=audioUrl;return this.whenLoaded((function(_this){return function(){var a,item,middle,text;if(_this.audioUrl){middle=_this.toolbarElement().querySelector(".middle");item=document.createElement("div");item.classList.add("item");item.classList.add("emphasized");a=_this.anchor(_this.audioUrl);text=document.createTextNode("Listen");a.appendChild(text);item.appendChild(a);return middle.appendChild(item);}};})(this));};Toolbar.prototype.setSend=function(shareUrl){this.shareUrl=shareUrl;return this.whenLoaded((function(_this){return function(){var a,action,left;left=_this.toolbarElement().querySelector(".left");action=left.querySelector(".action.send");if(action){if(_this.shareUrl){a=action.querySelector("a");return a.href=_this.shareUrl;}else{return action.parentNode.remove();}}};})(this));};Toolbar.prototype.setMore=function(){return this.whenLoaded((function(_this){return function(){var a,action,left;left=_this.toolbarElement().querySelector(".left");action=left.querySelector(".action.more");if(action){if(_this.refindUrl){a=action.querySelector("a");return a.href=_this.refindUrl;}else{return action.parentNode.remove();}}};})(this));};Toolbar.prototype.setExtra=function(type,url){this.extraType=type;this.extraUrl=url;return this.whenLoaded((function(_this){return function(){var action,left;left=_this.toolbarElement().querySelector(".left");action=left.querySelector(".action.extra");if(action){if(_this.extraType){return action.classList.add(_this.extraType);}else{return action.parentNode.remove();}}};})(this));};Toolbar.prototype.whenLoaded=function(closure){if(this.loaded){return closure();}else{return this.beforeLoaded.push(closure);}};Toolbar.prototype.toolbarElement=function(){return this.iframe.contentDocument.querySelector(".toolbar");};Toolbar.prototype.toolbarData=function(data){var userId;if(data.toolbar_condition===false){this.hide();return;}this.dataAvailable=true;userId=data.user_id;this.checkForChangedUserId(this.userId,userId);this.userId=userId;this.setLinkId(data.link_id);this.refindUrl=data.refind_url;this.setSaved(data.saved);this.setStarred(data.starred);this.setArchived(data.archived);this.setSend(data.share_url);this.setExtra(data.extra_type,data.extra_url);this.setMore();this.clearMiddle();this.setSavers(data.savers);this.setInteractionCount(data.interaction_count,data.interaction_count_text);this.setComments(data.comment_url,data.comment_count,data.comment_count_text);this.setSummaryUrl(data.summary_url);this.setAudioUrl(data.audio_url);if(this.isEnabled(this.enabled,this.sessionEnabled,this.domainBlacklist,this.spaBlacklist)){if(!this.inserted){this.inserted=true;this.insertFrame();this.setupFrame();}this.show();}if(this.shown){return this.applyModifications(data.toolbar_modifications);}};Toolbar.prototype.userIdChanged=function(){return this.resetSettings();};Toolbar.prototype.checkForChangedUserId=function(old,niu){if(old===this.initialUserId){return;}if(niu!==old){return this.userIdChanged(old,niu);}};Toolbar.prototype.urlChanged=function(newUrl){return this.askForData(newUrl);};Toolbar.prototype.startUrlCheck=function(interval){window.onunload=(function(_this){return function(){return _this.urlCheckIntervalId=null;};})(this);return this.urlCheckIntervalId=setInterval((function(_this){return function(){var newUrl;newUrl=window.location.href;if(_this.href!==newUrl){_this.urlChanged(newUrl);return _this.cacheHref();}};})(this),interval);};Toolbar.prototype.installHistoryHooks=function(){return this.startUrlCheck(200);};Toolbar.prototype.installHooks=function(){var action,actions,func,mappings,results1,selector;mappings={".action.settings":this.showSettings,".action.close":this.close,".action.close-session a":this.closeSession,".action.close-domain a":this.closeDomain,".action.close-forever a":this.closeForever,".action.save a":this.save,".action.read-soon a":this.read,".action.send a":this.send,".action.extra a":this.extra,".action.more a":this.more,".action.random a":this.random};results1=[];for(selector in mappings){func=mappings[selector];actions=this.iframe.contentDocument.querySelectorAll(selector);results1.push((function(){var i,len,results2;results2=[];for(i=0,len=actions.length;i<len;i++){action=actions[i];results2.push(action.onclick=func);}return results2;})());}return results1;};Toolbar.prototype.installElements=function(){var element,elements,i,len,results1;this.toolbarElement().querySelector(".action.close-domain .domain").innerHTML="Disable for "+(this.domain());elements=this.toolbarElement().querySelectorAll(".row1");results1=[];for(i=0,len=elements.length;i<len;i++){element=elements[i];element.style.overflow="hidden";element.style.height=this.height;element.style.maxHeight=this.height;results1.push(element.style.transition="max-height 0.1s ease-in");}return results1;};Toolbar.prototype.apiCallResults=function(fn,params,response){if(response.login_required){window.open(document.environment+"/login");return;}if(response.success){switch(fn){case"saveLink":this.stopSpin("save");this.setSaved(true);return this.setLinkId(response.link_id);case"unsaveLink":this.stopSpin("save");return this.setSaved(false);case"addReadSoonUrl":this.stopSpin("read-soon");this.setStarred(true);this.setArchived(false);return this.setLinkId(response.link_id);case"archiveReadSoon":this.stopSpin("read-soon");this.setStarred(false);return this.setArchived(true);case"deleteReadSoon":this.stopSpin("read-soon");this.setStarred(false);return this.setArchived(false);case"randomLink":return window.location.href="https://refind.com/i/random";}}};Toolbar.prototype.startSpin=function(klass){return this.toolbarElement().querySelector(".action."+klass).classList.add("spin");};Toolbar.prototype.stopSpin=function(klass){return this.toolbarElement().querySelector(".action."+klass).classList.remove("spin");};Toolbar.prototype.save=function(){var payload;this.startSpin("save");if(this.saved){if(this.linkId){payload={fn:"unsaveLink",params:{link_id:this.linkId}};return this.browser.send("api_call",payload);}}else{payload={fn:"saveLink",params:{user_url:this.location.href,user_title:document.title}};return this.browser.send("api_call",payload);}};Toolbar.prototype.read=function(){var payload;this.startSpin("read-soon");if(this.starred){if(this.linkId){payload={fn:"archiveReadSoon",params:{link_id:this.linkId}};return this.browser.send("api_call",payload);}}else{if(this.archived){if(this.linkId){payload={fn:"deleteReadSoon",params:{link_id:this.linkId}};return this.browser.send("api_call",payload);}}else{payload={fn:"addReadSoonUrl",params:{user_url:this.location.href,user_title:document.title}};return this.browser.send("api_call",payload);}}};Toolbar.prototype.extra=function(){if(this.extraUrl){window.open(this.extraUrl);return false;}};Toolbar.prototype.random=function(){var payload;payload={fn:"randomLink",params:{link_id:this.linkId,mark_seen:true}};return this.browser.send("api_call",payload);};Toolbar.prototype.send=function(){if(this.shareUrl){window.open(this.shareUrl);return false;}};Toolbar.prototype.more=function(){if(this.refindUrl){window.open(this.refindUrl);return false;}};Toolbar.prototype.anchor=function(url){var a;a=document.createElement("a");a.href=url;a.onclick=(function(_this){return function(){window.open(url);return false;};})(this);return a;};Toolbar.prototype.show=function(){this.iframe.style.maxHeight=this.height;return this.shown=true;};Toolbar.prototype.close=function(){this.spaBlacklist.push(this.domain());return this.hide();};Toolbar.prototype.hide=function(){if(this.iframe){this.iframe.style.maxHeight="0";this.removeModifications();}return this.shown=false;};Toolbar.prototype.showSettings=function(){var element,elements,i,len,results1;elements=this.toolbarElement().querySelectorAll(".row1");results1=[];for(i=0,len=elements.length;i<len;i++){element=elements[i];if(element.style.maxHeight==="0px"){results1.push(element.style.maxHeight=this.height);}else{results1.push(element.style.maxHeight="0px");}}return results1;};Toolbar.prototype.applyModifications=function(modifications){var _,entry,i,j,len,len1,ref,ref1,ref2,results1,show;this.modifications=modifications;if(this.modifications){ref=this.modifications;for(i=0,len=ref.length;i<len;i++){ref1=ref[i],show=ref1[0],_=ref1[1];eval(show);}}if(this.globalModifications){ref2=this.globalModifications;results1=[];for(j=0,len1=ref2.length;j<len1;j++){entry=ref2[j];if(eval(entry.condition)){eval(entry.show);this.modifications||(this.modifications=[]);results1.push(this.modifications.push([entry.show,entry.hide]));}else{results1.push(void 0);}}return results1;}};Toolbar.prototype.removeModifications=function(){var _,hide,i,len,ref,ref1,results1;if(this.modifications){ref=this.modifications;results1=[];for(i=0,len=ref.length;i<len;i++){ref1=ref[i],_=ref1[0],hide=ref1[1];results1.push(eval(hide));}return results1;}};Toolbar.prototype.closeSession=function(){this.showSettings();this.close();return this.browser.send("settings_toolbar_session_enabled",{enabled:false});};Toolbar.prototype.closeDomain=function(){var payload;this.showSettings();this.close();payload={fn:"blacklistDomain",params:{domain:this.domain(),add:true}};return this.browser.send("api_call",payload);};Toolbar.prototype.closeForever=function(){var payload;this.showSettings();this.close();payload={fn:"setToolbarEnabled",params:{state:false}};return this.browser.send("api_call",payload);};Toolbar.prototype.domain=function(){return this.memoizedDomain||(this.memoizedDomain=this.location.hostname.split(".").slice(-2).join("."));};return Toolbar;})();window.URLs=URLs=(function(){var getAPIOpenLinkURL;function URLs(root1){this.root=root1;this.isDebug=bind(this.isDebug,this);this.isDevelopment=bind(this.isDevelopment,this);this.getAbsoluteURL=bind(this.getAbsoluteURL,this);this.getAPISettingsURL=bind(this.getAPISettingsURL,this);this.getAPISearchURL=bind(this.getAPISearchURL,this);this.getNewURL=bind(this.getNewURL,this);this.getQueryURLTemplate=bind(this.getQueryURLTemplate,this);this.getQueryURL=bind(this.getQueryURL,this);this.getAPIRemoveTagURL=bind(this.getAPIRemoveTagURL,this);this.getAPISaveTagURL=bind(this.getAPISaveTagURL,this);this.getAPIShareLinkURL=bind(this.getAPIShareLinkURL,this);this.getAPIAddNoteURL=bind(this.getAPIAddNoteURL,this);this.getAPIDeleteReadSoonURL=bind(this.getAPIDeleteReadSoonURL,this);this.getAPIArchiveReadSoonURL=bind(this.getAPIArchiveReadSoonURL,this);this.getAPIAddReadSoonURL=bind(this.getAPIAddReadSoonURL,this);this.getAPIAddReadSoonUrlURL=bind(this.getAPIAddReadSoonUrlURL,this);this.getAPIGroupSaveLinkURL=bind(this.getAPIGroupSaveLinkURL,this);this.getAPIUnsaveLinkURL=bind(this.getAPIUnsaveLinkURL,this);this.getAPISaveLinkURL=bind(this.getAPISaveLinkURL,this);this.getBlacklistDomainURL=bind(this.getBlacklistDomainURL,this);this.getRandomLinkURL=bind(this.getRandomLinkURL,this);this.getLinkInfoURL=bind(this.getLinkInfoURL,this);this.getToolbarDataURL=bind(this.getToolbarDataURL,this);this.getToolbarURL=bind(this.getToolbarURL,this);this.getToolbarSettingsURL=bind(this.getToolbarSettingsURL,this);this.getRefindURL=bind(this.getRefindURL,this);this.apiSaveLinkPath="/api/link/save";this.apiUnsaveLinkPath="/api/link/unsave";this.apiGroupSaveLinkPath="/api/group/link/save";this.apiAddReadSoonUrlPath="/api/read_soon/add_url";this.apiAddReadSoonPath="/api/read_soon/add";this.apiArchiveReadSoonPath="/api/read_soon/remove";this.apiDeleteReadSoonPath="/api/read_soon/delete";this.apiAddNotePath="/api/link/note/save";this.apiOpenLinkPath="/api/link/open";this.apiShareLinkPath="/api/link/share";this.apiSaveTagPath="/api/link/tag/save";this.apiRemoveTagPath="/api/link/tag/remove";this.apiSearchPath="/api/search";this.apiSettingsPath="/api/settings";this.queryPath="/search/";this.newPath="/i/new";this.linkInfoPath="/api/link";this.toolbarPath="/api/templates/toolbar.html";this.toolbarDataPath="/api/toolbar/data.json";this.randomLinkPath="/api/link/random";this.toolbarSettingsPath="/i/settings/extension_toolbar";this.blacklistDomainPath="/i/settings/extension_toolbar_blacklist";}URLs.prototype.getRefindURL=function(){return this.root;};URLs.prototype.getToolbarSettingsURL=function(){return this.getRefindURL()+this.toolbarSettingsPath;};URLs.prototype.getToolbarURL=function(){return this.getRefindURL()+this.toolbarPath;};URLs.prototype.getToolbarDataURL=function(){return this.getRefindURL()+this.toolbarDataPath;};URLs.prototype.getLinkInfoURL=function(){return this.getRefindURL()+this.linkInfoPath;};URLs.prototype.getRandomLinkURL=function(){return this.getRefindURL()+this.randomLinkPath;};URLs.prototype.getBlacklistDomainURL=function(){return this.getRefindURL()+this.blacklistDomainPath;};URLs.prototype.getAPISaveLinkURL=function(){return this.getRefindURL()+this.apiSaveLinkPath;};URLs.prototype.getAPIUnsaveLinkURL=function(){return this.getRefindURL()+this.apiUnsaveLinkPath;};URLs.prototype.getAPIGroupSaveLinkURL=function(){return this.getRefindURL()+this.apiGroupSaveLinkPath;};URLs.prototype.getAPIAddReadSoonUrlURL=function(){return this.getRefindURL()+this.apiAddReadSoonUrlPath;};URLs.prototype.getAPIAddReadSoonURL=function(){return this.getRefindURL()+this.apiAddReadSoonPath;};URLs.prototype.getAPIArchiveReadSoonURL=function(){return this.getRefindURL()+this.apiArchiveReadSoonPath;};URLs.prototype.getAPIDeleteReadSoonURL=function(){return this.getRefindURL()+this.apiDeleteReadSoonPath;};URLs.prototype.getAPIAddNoteURL=function(){return this.getRefindURL()+this.apiAddNotePath;};URLs.prototype.getAPIShareLinkURL=function(){return this.getRefindURL()+this.apiShareLinkPath;};URLs.prototype.getAPISaveTagURL=function(){return this.getRefindURL()+this.apiSaveTagPath;};URLs.prototype.getAPIRemoveTagURL=function(){return this.getRefindURL()+this.apiRemoveTagPath;};URLs.prototype.getQueryURL=function(query){return this.getRefindURL()+this.queryPath+encodeURIComponent(query);};URLs.prototype.getQueryURLTemplate=function(){return this.getRefindURL()+this.queryPath+"{query}";};URLs.prototype.getNewURL=function(){return this.getRefindURL()+this.newPath;};URLs.prototype.getAPISearchURL=function(){return this.getRefindURL()+this.apiSearchPath;};getAPIOpenLinkURL=function(){return URLs.getRefindURL()+URLs.apiOpenLinkPath;};URLs.prototype.getAPISettingsURL=function(){return this.getRefindURL()+this.apiSettingsPath;};URLs.prototype.getAbsoluteURL=function(path){if(path.match(/^http/)){return path;}else{return this.getRefindURL()+path;}};URLs.prototype.isDevelopment=function(){return this.isDebug();};URLs.prototype.isDebug=function(){return this.root==="http://localhost:5000";};return URLs;})();window.API=API=(function(){function API(url1,browser1){this.url=url1;this.browser=browser1;this.postRequest=bind(this.postRequest,this);this.getRequest=bind(this.getRequest,this);this.ajaxCall=bind(this.ajaxCall,this);this.search=bind(this.search,this);this.removeTag=bind(this.removeTag,this);this.saveTag=bind(this.saveTag,this);this.shareLink=bind(this.shareLink,this);this.openLink=bind(this.openLink,this);this.addNote=bind(this.addNote,this);this.deleteReadSoon=bind(this.deleteReadSoon,this);this.archiveReadSoon=bind(this.archiveReadSoon,this);this.addReadSoon=bind(this.addReadSoon,this);this.addReadSoonUrl=bind(this.addReadSoonUrl,this);this.groupSaveLink=bind(this.groupSaveLink,this);this.unsaveLink=bind(this.unsaveLink,this);this.saveLink=bind(this.saveLink,this);this.blacklistDomain=bind(this.blacklistDomain,this);this.randomLink=bind(this.randomLink,this);this.getLinkInfo=bind(this.getLinkInfo,this);this.getToolbarData=bind(this.getToolbarData,this);this.getToolbar=bind(this.getToolbar,this);this.setToolbarEnabled=bind(this.setToolbarEnabled,this);this.getSettings=bind(this.getSettings,this);}API.prototype.getSettings=function(data,callback){return this.postRequest(this.url.getAPISettingsURL(),data,callback);};API.prototype.setToolbarEnabled=function(data,callback){return this.postRequest(this.url.getToolbarSettingsURL(),data,callback);};API.prototype.getToolbar=function(data,callback){return this.getRequest(this.url.getToolbarURL(),data,callback);};API.prototype.getToolbarData=function(data,callback){return this.getRequest(this.url.getToolbarDataURL(),data,callback);};API.prototype.getLinkInfo=function(data,callback){return this.getRequest(this.url.getLinkInfoURL(),data,callback);};API.prototype.randomLink=function(data,callback){return this.getRequest(this.url.getRandomLinkURL(),data,callback);};API.prototype.blacklistDomain=function(data,callback){return this.postRequest(this.url.getBlacklistDomainURL(),data,callback);};API.prototype.saveLink=function(data,callback){return this.postRequest(this.url.getAPISaveLinkURL(),data,callback);};API.prototype.unsaveLink=function(data,callback){return this.postRequest(this.url.getAPIUnsaveLinkURL(),data,callback);};API.prototype.groupSaveLink=function(data,callback){return this.postRequest(this.url.getAPIGroupSaveLinkURL(),data,callback);};API.prototype.addReadSoonUrl=function(data,callback){return this.postRequest(this.url.getAPIAddReadSoonUrlURL(),data,callback);};API.prototype.addReadSoon=function(data,callback){return this.postRequest(this.url.getAPIAddReadSoonURL(),data,callback);};API.prototype.archiveReadSoon=function(data,callback){return this.postRequest(this.url.getAPIArchiveReadSoonURL(),data,callback);};API.prototype.deleteReadSoon=function(data,callback){return this.postRequest(this.url.getAPIDeleteReadSoonURL(),data,callback);};API.prototype.addNote=function(data,callback){return this.postRequest(this.url.getAPIAddNoteURL(),data,callback);};API.prototype.openLink=function(data,callback){return this.postRequest(this.url.getAPIOpenLinkURL(),data,callback);};API.prototype.shareLink=function(data,callback){return this.postRequest(this.url.getAPIShareLinkURL(),data,callback);};API.prototype.saveTag=function(data,callback){return this.postRequest(this.url.getAPISaveTagURL(),data,callback);};API.prototype.removeTag=function(data,callback){return this.postRequest(this.url.getAPIRemoveTagURL(),data,callback);};API.prototype.search=function(data,callback){return this.postRequest(this.url.getAPISearchURL(),data,callback);};API.prototype.ajaxCall=function(config,callback){var data,type,url;type=config.type;url=this.url.getAbsoluteURL(config.url);data=config.data||{};switch(type){case"GET":return this.getRequest(url,data,callback);case"POST":return this.postRequest(url,data,callback);}};API.prototype.getRequest=function(url,data,callback){return this.browser.getClientVersion((function(_this){return function(clientVersion){data.client=_this.browser.getClientName();data.client_version=clientVersion;data.user_agent=_this.browser.getUserAgent();return $.get(url,data,function(response){return callback&&callback(response);});};})(this));};API.prototype.postRequest=function(url,data,callback){return this.browser.getClientVersion((function(_this){return function(clientVersion){data.client=_this.browser.getClientName();data.client_version=clientVersion;data.user_agent=_this.browser.getUserAgent();return $.post(url,data,function(response){return callback&&callback(response);});};})(this));};return API;})();window.BrowserAdapter=BrowserAdapter=(function(){var htmlReplacements;function BrowserAdapter(adapter,url1){this.adapter=adapter;this.url=url1;this.addWatermark=bind(this.addWatermark,this);this.updateCheck=bind(this.updateCheck,this);this.resizePopover=bind(this.resizePopover,this);this.setupPopover=bind(this.setupPopover,this);this.sendFromPopover=bind(this.sendFromPopover,this);this.send=bind(this.send,this);this.on=bind(this.on,this);this.refindInstanceFrom=this.adapter.refindInstanceFrom;this.chrome="chrome";this.safari="safari";this.firefox="firefox";this["with"]=(function(_this){return function(id,callback){if(id===_this.adapter.id){return callback();}};})(this);this.setupBackground=this.adapter.setupBackground;this.setupSearchEngine=this.adapter.setupSearchEngine;this.setupInserts=this.adapter.setupInserts;this.broadcast=this.adapter.broadcast;this.getClientName=this.adapter.getClientName;this.getClientVersion=this.adapter.getClientVersion;this.getExtensionVersion=this.adapter.getExtensionVersion;this.canHighlight=this.adapter.canHighlight;this.getCurrentURL=this.adapter.getCurrentURL;this.getCurrentTitle=this.adapter.getCurrentTitle;this.getCurrentFaviconURL=this.adapter.getCurrentFaviconURL;this.getCurrentSelection=this.adapter.getCurrentSelection;this.askCurrentToolbarShown=this.adapter.askCurrentToolbarShown;this.cachePopupDom=this.adapter.cachePopupDom;this.openURL=this.adapter.openURL;this.hidePopover=this.adapter.hidePopover;this.reload=this.adapter.reload;this.isPrivate=this.adapter.isPrivate;this.debug=this.adapter.debug;this.localMessages={};}BrowserAdapter.prototype.on=function(id,callback,options){if(options==null){options={};}if(options.local){return this.localMessages[id]=callback;}else{return this.adapter.on(id,callback);}};BrowserAdapter.prototype.send=function(id,data,thing){var callback;if(callback=this.localMessages[id]){return callback(data,thing);}else{return this.adapter.send(id,data,thing);}};BrowserAdapter.prototype.sendFromPopover=function(id,data,tab){var callback;if(callback=this.localMessages[id]){return callback(data,tab);}else{return this.adapter.sendFromPopover(id,data,tab);}};BrowserAdapter.prototype.getUserAgent=function(){return navigator.userAgent;};BrowserAdapter.prototype.setupPopover=function(refind,popover,api){return this.adapter.setupPopover(refind,popover,api,this);};BrowserAdapter.prototype.getPopover=function(){return document;};BrowserAdapter.prototype.resizePopover=function(){return this.adapter.resizePopover(this.getPopover());};BrowserAdapter.prototype.updateCheck=function(){if(this.url.isDevelopment()){return;}return this.adapter.updateCheck(function(){return this.adapter.reload();});};BrowserAdapter.prototype.addWatermark=function(){var div,name;div=document.createElement("div");name=this.adapter.getClientName();div.id="com-refind-"+name;div.dataset.clientName=name;this.adapter.getClientVersion((function(_this){return function(version){return div.dataset.clientVersion=version;};})(this));return document.body.appendChild(div);};htmlReplacements={"&":"&amp;",'"':"&quot;","<":"&lt;",">":"&gt;"};BrowserAdapter.prototype.escapeHTML=function(str){return str.replace(/[&"<>]/g,function(m){return htmlReplacements[m];});};return BrowserAdapter;})();window.Popover=Popover=(function(){function Popover(browser1,api1,root1){this.browser=browser1;this.api=api1;this.root=root1;this.replaceNode=bind(this.replaceNode,this);this.domainFrom=bind(this.domainFrom,this);this.setSaveExplainer=bind(this.setSaveExplainer,this);this.saveSelectedText=bind(this.saveSelectedText,this);this.saveSelectedTextButton=bind(this.saveSelectedTextButton,this);this.shareFacebook=bind(this.shareFacebook,this);this.shareFacebookLink=bind(this.shareFacebookLink,this);this.shareTwitter=bind(this.shareTwitter,this);this.shareTwitterLink=bind(this.shareTwitterLink,this);this.send=bind(this.send,this);this.sendLink=bind(this.sendLink,this);this.share=bind(this.share,this);this.shareLink=bind(this.shareLink,this);this.linkChatAction=bind(this.linkChatAction,this);this.allLinkChatActions=bind(this.allLinkChatActions,this);this.openUrl=bind(this.openUrl,this);this.installAnchorEventListeners=bind(this.installAnchorEventListeners,this);this.addEventListeners=bind(this.addEventListeners,this);this.addGroupEventListeners=bind(this.addGroupEventListeners,this);this.groupSaveButtonClick=bind(this.groupSaveButtonClick,this);this.addShareEventListener=bind(this.addShareEventListener,this);this.addMessagesEventListener=bind(this.addMessagesEventListener,this);this.createCollectionAction=bind(this.createCollectionAction,this);this.createCollection=bind(this.createCollection,this);this.openInRefindLinks=bind(this.openInRefindLinks,this);this.openInRefind=bind(this.openInRefind,this);this.archiveActionButton=bind(this.archiveActionButton,this);this.archiveAction=bind(this.archiveAction,this);this.readSoonActionButton=bind(this.readSoonActionButton,this);this.readSoonActionSavedAt=bind(this.readSoonActionSavedAt,this);this.readSoonAction=bind(this.readSoonAction,this);this.groupSaveActions=bind(this.groupSaveActions,this);this.groupSaveActionButton=bind(this.groupSaveActionButton,this);this.groupSaveActionSavedAt=bind(this.groupSaveActionSavedAt,this);this.groupSaveAction=bind(this.groupSaveAction,this);this.saveActionButton=bind(this.saveActionButton,this);this.saveActionSavedAt=bind(this.saveActionSavedAt,this);this.saveAction=bind(this.saveAction,this);this.showToolbarLink=bind(this.showToolbarLink,this);this.dialog=bind(this.dialog,this);this.showDialog=bind(this.showDialog,this);this.modifyDomainBlacklist=bind(this.modifyDomainBlacklist,this);this.setToolbarEnabled=bind(this.setToolbarEnabled,this);this.setUIGroupSaved=bind(this.setUIGroupSaved,this);this.setOptimisticUIGroupSaved=bind(this.setOptimisticUIGroupSaved,this);this.setUIStarred=bind(this.setUIStarred,this);this.setUISaved=bind(this.setUISaved,this);this.setRequiresExistingLink=bind(this.setRequiresExistingLink,this);this.readSoonedUrl=bind(this.readSoonedUrl,this);this.readSoonUrl=bind(this.readSoonUrl,this);this.groupSaveLink=bind(this.groupSaveLink,this);this.linkSaved=bind(this.linkSaved,this);this.saveLink=bind(this.saveLink,this);this.openRefindIfBlank=bind(this.openRefindIfBlank,this);this.readSoon=bind(this.readSoon,this);this.groupSave=bind(this.groupSave,this);this.save=bind(this.save,this);this.askForData=bind(this.askForData,this);this.linkData=bind(this.linkData,this);this.someData=bind(this.someData,this);this.replaceCachedGroupsData=bind(this.replaceCachedGroupsData,this);this.handleMessagesData=bind(this.handleMessagesData,this);this.handleSharedData=bind(this.handleSharedData,this);this.showTags=bind(this.showTags,this);this.replaceGroups=bind(this.replaceGroups,this);this.insertDataIntoView=bind(this.insertDataIntoView,this);this.insertSuggestionsDataIntoView=bind(this.insertSuggestionsDataIntoView,this);this.createSaveCountLink=bind(this.createSaveCountLink,this);this.insertFaceDataIntoView=bind(this.insertFaceDataIntoView,this);this.renderData=bind(this.renderData,this);this.cachedData=bind(this.cachedData,this);this.getLinkId=bind(this.getLinkId,this);this.setLinkId=bind(this.setLinkId,this);this.handleFeedback=bind(this.handleFeedback,this);this.toolbarShownResults=bind(this.toolbarShownResults,this);this.initialWithToolbarInfo=bind(this.initialWithToolbarInfo,this);this.cacheDom=bind(this.cacheDom,this);this.rememberDom=bind(this.rememberDom,this);this.clearDom=bind(this.clearDom,this);this.insertDom=bind(this.insertDom,this);this.initial=bind(this.initial,this);this.setup=bind(this.setup,this);this.resize=this.browser.resizePopover;this.data=null;this.defaultAction=null;this.nodes=null;}Popover.prototype.setup=function(refind1){this.refind=refind1;return this.browser.setupPopover(this.refind,this,this.api);};Popover.prototype.initial=function(){return this.browser.sendFromPopover("settings_data",{},(function(_this){return function(data){_this.defaultAction=data.default_action;if(_this.defaultAction&&_this.defaultAction>0){_this.setSaveExplainer("saving");}else{_this.setSaveExplainer("save");}_this.cacheDom();if(data.groups){_this.replaceGroups(data.groups);}_this.askForData(true);_this.addEventListeners();_this.browser.askCurrentToolbarShown(_this);_this.askCurrentToolbarShownTimeoutId=setTimeout(function(){return _this.toolbarShownResults({shown:true});},100);return _this.showDialog();};})(this));};Popover.prototype.insertDom=function(){var i,len,node,ref,results1;ref=this.nodes;results1=[];for(i=0,len=ref.length;i<len;i++){node=ref[i];results1.push(document.appendChild(node.cloneNode(true)));}return results1;};Popover.prototype.clearDom=function(){var results1;results1=[];while(document.firstChild){results1.push(document.removeChild(document.firstChild));}return results1;};Popover.prototype.rememberDom=function(){if(this.browser.cachePopupDom()){return this.nodes=Array.from(document.childNodes).map((function(_this){return function(node){return node.cloneNode(true);};})(this));}};Popover.prototype.cacheDom=function(){if(this.browser.cachePopupDom()){if(this.nodes){this.clearDom();return this.insertDom();}else{return this.rememberDom();}}};Popover.prototype.initialWithToolbarInfo=function(shown){return this.browser.sendFromPopover("settings_data",{},(function(_this){return function(data){};})(this));};Popover.prototype.toolbarShownResults=function(data){clearTimeout(this.askCurrentToolbarShownTimeoutId);return this.initialWithToolbarInfo(data.shown);};Popover.prototype.handleFeedback=function(data){var feedback;if(feedback=data.feedback){return this.showDialog(feedback);}};Popover.prototype.setLinkId=function(data){if(data.link_id){return $("body").data("link-id",data.link_id);}};Popover.prototype.getLinkId=function(){return $("body").data("link-id");};Popover.prototype.cachedData=function(callback){this.dataCallback=callback;if(this.data){if(this.dataCallback){this.dataCallback(this.data);return this.dataCallback=null;}}else{return this.askForData(false);}};Popover.prototype.renderData=function(updateGroups){if(updateGroups==null){updateGroups=true;}return this.cachedData((function(_this){return function(data){_this.insertDataIntoView(data,updateGroups);return _this.showTags();};})(this));};Popover.prototype.insertFaceDataIntoView=function(data){var facesDiv;facesDiv=document.querySelector("body .box.faces");if(data.success&&data.interaction_count>0){this.replaceNode(facesDiv,(function(_this){return function(node){var friendFaces,saveCountLink;friendFaces=data.friend_faces;if(friendFaces&&friendFaces.length>0){friendFaces.forEach(function(face){var friendLink,img;friendLink=document.createElement("a");friendLink.setAttribute("href",face.href);friendLink.classList.add("anchor-action");friendLink.setAttribute("target","_blank");img=document.createElement("img");img.setAttribute("src",face.image_url);friendLink.appendChild(img);return node.appendChild(friendLink);});if(data.interaction_count>0){saveCountLink=_this.createSaveCountLink(""+data.interaction_count,data.refind_url);node.appendChild(saveCountLink);}node.style.display="block";}else{if(data.interaction_count>1){saveCountLink=_this.createSaveCountLink(data.interaction_count_text,data.refind_url);node.appendChild(saveCountLink);node.style.display="block";}}return _this.showDialog();};})(this));}return this.installAnchorEventListeners(facesDiv);};Popover.prototype.createSaveCountLink=function(text,url){var saveCountLink,saveCountLinkText;saveCountLink=document.createElement("a");saveCountLinkText=document.createTextNode(text);saveCountLink.appendChild(saveCountLinkText);saveCountLink.classList.add("save-count");saveCountLink.classList.add("anchor-action");saveCountLink.setAttribute("target","_blank");saveCountLink.setAttribute("href",url);return saveCountLink;};Popover.prototype.insertSuggestionsDataIntoView=function(data){var suggestionsDiv;suggestionsDiv=document.querySelector("body .box.suggestions");if(data.success&&data.suggestions&&data.suggestions.length>0){this.replaceNode(suggestionsDiv,(function(_this){return function(node){var h1,h1Text,suggestions;suggestions=data.suggestions;h1=document.createElement("h1");h1Text=document.createTextNode("Suggestions");h1.appendChild(h1Text);node.appendChild(h1);suggestions.forEach(function(suggestion){var hostLink,hostLinkText,imageLink,img,leftDiv,rightDiv,suggestionDiv,titleLink,titleLinkText;suggestionDiv=document.createElement("div");suggestionDiv.classList.add("suggestion");leftDiv=document.createElement("div");leftDiv.style.display="inline-block";leftDiv.classList.add("left");titleLink=document.createElement("a");titleLinkText=document.createTextNode(suggestion.title);titleLink.appendChild(titleLinkText);titleLink.classList.add("title");titleLink.classList.add("anchor-action");titleLink.setAttribute("target","_blank");titleLink.setAttribute("href",suggestion.url);hostLink=document.createElement("a");hostLinkText=document.createTextNode(suggestion.host);hostLink.appendChild(hostLinkText);hostLink.classList.add("host");hostLink.classList.add("anchor-action");hostLink.setAttribute("target","_blank");hostLink.setAttribute("href",suggestion.url);leftDiv.appendChild(titleLink);leftDiv.appendChild(hostLink);rightDiv=document.createElement("div");rightDiv.style.display="inline-block";rightDiv.classList.add("right");if(suggestion.image_url){imageLink=document.createElement("a");img=document.createElement("img");img.setAttribute("src",suggestion.image_url);imageLink.appendChild(img);imageLink.classList.add("anchor-action");imageLink.setAttribute("target","_blank");imageLink.setAttribute("href",suggestion.url);rightDiv.appendChild(imageLink);}suggestionDiv.appendChild(leftDiv);suggestionDiv.appendChild(rightDiv);return node.appendChild(suggestionDiv);});return node.style.display="block";};})(this));this.resize();return this.installAnchorEventListeners(suggestionsDiv);}};Popover.prototype.insertDataIntoView=function(data,updateGroups){var i,j,len,len1,ref,ref1,tag,tagsList,typeahead;if(!data.success){this.handleFeedback(data);return;}if(updateGroups){if(data.groups){this.replaceGroups(data.groups);this.browser.sendFromPopover("reset_settings");}}if(data.saved){this.setUISaved(data);}if(data.starred){this.setUIStarred(data);}if(data.group_saved){this.setUIGroupSaved(data);}this.setSaveExplainer("save");this.handleSharedData(data);if(data.top_tags||data.user_tags){if(data.top_tags){ref=data.top_tags;for(i=0,len=ref.length;i<len;i++){tag=ref[i];tagsList=$(".tags-list")[0];window.tagsAppendTag(tagsList,tag.name,false);}}if(data.user_tags){ref1=data.user_tags;for(j=0,len1=ref1.length;j<len1;j++){tag=ref1[j];tagsList=$(".tags-list")[0];window.tagsAppendTag(tagsList,tag.name,true);}}}typeahead=window.tagsSetup();typeahead.bind("typeahead:open",(function(_this){return function(){return _this.resize();};})(this));typeahead.bind("typeahead:close",(function(_this){return function(){return _this.resize();};})(this));if(data.saved||data.starred||data.archived){this.showTags();}return this.showDialog();};Popover.prototype.replaceGroups=function(groups){var groupsDiv,popover;popover=this.browser.getPopover();groupsDiv=popover.querySelector(".save-actions .groups");this.replaceNode(groupsDiv,(function(_this){return function(node){var action,button,caption,description,descriptionText,details,group,i,icon,len,middle,results1,right,title,titleText;results1=[];for(i=0,len=groups.length;i<len;i++){group=groups[i];action=document.createElement("div");action.classList.add("action");action.classList.add("group-save");action.setAttribute("data-group-id",group.id);action.setAttribute("data-group-path",group.path);middle=document.createElement("div");middle.classList.add("middle");caption=document.createElement("div");caption.classList.add("caption");title=document.createElement("div");title.classList.add("title");titleText=document.createTextNode(group.name);title.appendChild(titleText);description=document.createElement("div");description.classList.add("description");if(group.secret){icon=document.createElement("span");icon.innerHTML="<i class='fa fa-lock' style='margin-right: 4px;'></i>";description.appendChild(icon);}if(group.details){details=document.createElement("span");descriptionText=document.createTextNode(group.details);details.appendChild(descriptionText);description.appendChild(details);}caption.appendChild(title);caption.appendChild(description);middle.appendChild(caption);right=document.createElement("div");right.classList.add("right");button=document.createElement("button");right.appendChild(button);action.appendChild(middle);action.appendChild(right);results1.push(node.appendChild(action));}return results1;};})(this));return this.addGroupEventListeners();};Popover.prototype.showTags=function(){return $(".box.tags-container").show();};Popover.prototype.handleSharedData=function(data){if(data.share_url&&data.share_facebook_url&&data.share_twitter_url){this.showShare();return this.addShareEventListener();}};Popover.prototype.showShare=function(){};Popover.prototype.handleMessagesData=function(data){if(data.messages_featured_html){this.showMessages();if(data.messages_featured_html){this.insertHTML(data.messages_featured_html);}return this.addMessagesEventListener();}};Popover.prototype.insertHTML=function(html){return $(".box.messages").html(html);};Popover.prototype.showMessages=function(){return $(".box.messages").show();};Popover.prototype.replaceCachedGroupsData=function(data){var cached_group_saved,exists,group_saved,i,j,len,len1,ref,ref1,results1;if(data.groups){this.data.groups=data.groups;}if(data.group_saved){if(!this.data.group_saved){this.data.group_saved=[];}ref=data.group_saved;results1=[];for(i=0,len=ref.length;i<len;i++){group_saved=ref[i];exists=false;ref1=this.data.group_saved;for(j=0,len1=ref1.length;j<len1;j++){cached_group_saved=ref1[j];if(cached_group_saved.id===group_saved.id){exists=true;}}if(!exists){results1.push(this.data.group_saved.push(group_saved));}else{results1.push(void 0);}}return results1;}};Popover.prototype.someData=function(data){this.setLinkId(data);return this.setRequiresExistingLink(data);};Popover.prototype.linkData=function(data){this.data=data;this.someData(this.data);if(this.dataCallback){this.dataCallback(this.data);}else{if(!data.success){this.insertDataIntoView(this.data,true);}else{if(data.group_saved||data.groups){this.replaceCachedGroupsData(data);}if(data.saved||data.starred||data.archived||data.group_saved||data.groups){this.insertDataIntoView(this.data,true);}}}return this.insertFaceDataIntoView(this.data);};Popover.prototype.askForData=function(default_action){if(default_action==null){default_action=true;}return this.browser.getCurrentURL((function(_this){return function(url){var config,extra;extra={default_action:default_action,user:false,refind_url:true,share_url:true,share_facebook_url:true,share_twitter_url:true,savers:false,saved_count:true,interaction_count:true,comment_count:true,comment_url:true,summary_url:true,extra_type:true,extra_url:true,audio_url:true,top_tags:true,top_tags_html:false,user_tags:true,friend_faces:true,suggestions:true,messages_featured_html:true,toolbar_modifications:false,toolbar_condition:false};config={origin:"popover",url:url,extra:extra};return _this.browser.sendFromPopover("maybe_link_data",config,_this.linkData);};})(this));};Popover.prototype.save=function(){return this.browser.getCurrentURL((function(_this){return function(url){return _this.browser.getCurrentTitle(function(title){return _this.browser.getCurrentFaviconURL(function(favicon){_this.setUISaved();_this.saveLink(false,url,title,favicon);return _this.renderData(false);});});};})(this));};Popover.prototype.groupSave=function(action,callback){var data,path;data=$(action).data();path=data.groupPath;return this.browser.getCurrentURL((function(_this){return function(url){return _this.browser.getCurrentTitle(function(title){return _this.browser.getCurrentFaviconURL(function(favicon){_this.setOptimisticUIGroupSaved(action);_this.groupSaveLink(false,path,url,title,favicon,callback);return _this.renderData(false);});});};})(this));};Popover.prototype.readSoon=function(){return this.browser.getCurrentURL((function(_this){return function(url){return _this.browser.getCurrentTitle(function(title){return _this.browser.getCurrentFaviconURL(function(favicon){_this.setUIStarred();_this.readSoonUrl(url,title,favicon);return _this.renderData(false);});});};})(this));};Popover.prototype.openRefindIfBlank=function(url,callback){if(url.match(/^about:|^chrome:/)){return this.openUrl("https://refind.com");}else{if(callback){return callback();}}};Popover.prototype.saveLink=function(confirmed,url,title,favIconUrl){var data;data={confirmed:confirmed,user_url:url,user_title:title,favicon_url:favIconUrl};return this.browser.sendFromPopover("save_link",data,this.linkSaved);};Popover.prototype.linkSaved=function(response){this.handleFeedback(response);if(response.success){this.someData(response);this.setUISaved();return this.showShare();}};Popover.prototype.groupSaveLink=function(confirmed,path,url,title,favIconUrl,callback){var data;data={confirmed:confirmed,path:path,user_url:url,user_title:title,favicon_url:favIconUrl};return this.browser.sendFromPopover("group_save_link",data,callback);};Popover.prototype.readSoonUrl=function(url,title,favIconUrl){var data;data={user_url:url,user_title:title,favicon_url:favIconUrl};return this.browser.sendFromPopover("add_read_soon_url",data,this.readSoonedUrl);};Popover.prototype.readSoonedUrl=function(response){this.handleFeedback(response);if(response.success){this.someData(response);this.setUIStarred();return this.showShare();}};Popover.prototype.setRequiresExistingLink=function(data){var displayString,popover;popover=this.browser.getPopover();displayString=data.link_id?"block":"none";return popover.querySelectorAll(".requires-existing-link").forEach(function(d){return d.style.display=displayString;});};Popover.prototype.setUISaved=function(data){var action,button;if(action=this.saveAction()){action.classList.add("disabled");}if(button=this.saveActionButton()){return button.setAttribute("disabled","disabled");}};Popover.prototype.setUIStarred=function(data){var action,button;if(action=this.readSoonAction()){action.classList.add("disabled");}if(button=this.readSoonActionButton()){return button.setAttribute("disabled","disabled");}};Popover.prototype.setOptimisticUIGroupSaved=function(el){return el.classList.add("disabled");};Popover.prototype.setUIGroupSaved=function(data){var action,button,group,i,id,len,ref,results1;ref=data.group_saved;results1=[];for(i=0,len=ref.length;i<len;i++){group=ref[i];id=group.id;if(action=this.groupSaveAction(id)){action.classList.add("disabled");}if(button=this.groupSaveActionButton(id)){results1.push(button.setAttribute("disabled","disabled"));}else{results1.push(void 0);}}return results1;};Popover.prototype.setSavedAt=function(div,text){return div.textContent=text;};Popover.prototype.setToolbarEnabled=function(enabled,force){var payload;if(force==null){force=false;}payload={fn:"setToolbarEnabled",params:{state:enabled,force:force}};return this.browser.sendFromPopover("api_call",payload);};Popover.prototype.modifyDomainBlacklist=function(add){return this.browser.getCurrentURL((function(_this){return function(url){var payload;payload={fn:"blacklistDomain",params:{domain:_this.domainFrom(url),add:add}};return _this.browser.sendFromPopover("api_call",payload);};})(this));};Popover.prototype.showDialog=function(feedback){var button,cta,dialog,error,popover;popover=this.browser.getPopover();popover.querySelectorAll(".dialog").forEach(function(d){return d.style.display="none";});if(feedback){if(feedback.welcome){dialog=popover.querySelector(".dialog.welcome");dialog.style.display="block";}else{if(feedback.welcome_login_required){dialog=popover.querySelector(".dialog.welcome-login-required");dialog.style.display="block";}else{if(feedback.reload){dialog=popover.querySelector(".dialog.reload");dialog.style.display="block";}else{if(error=feedback.error){dialog=popover.querySelector(".dialog.error");dialog.querySelector(".title").textContent=error.title;dialog.querySelector(".sentence").textContent=error.message;cta=error.cta;if(cta&&cta.url){button=dialog.querySelector(".action a");button.textContent=cta.label;button.setAttribute("href",cta.url);dialog.querySelector(".actions").style.display="block";}else{dialog.querySelector(".actions").style.display="none";}dialog.style.display="block";}}}}}else{dialog=popover.querySelector(".dialog.save");dialog.style.display="block";}return this.resize();};Popover.prototype.dialog=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".dialog.save");};Popover.prototype.showToolbarLink=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".show-toolbar");};Popover.prototype.saveAction=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.save");};Popover.prototype.saveActionSavedAt=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.save .description");};Popover.prototype.saveActionButton=function(){return this.saveAction().querySelector("button");};Popover.prototype.groupSaveAction=function(id){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.group-save[data-group-id='"+id+"']");};Popover.prototype.groupSaveActionSavedAt=function(id){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.group-save[data-group-id='"+id+"'] .description");};Popover.prototype.groupSaveActionButton=function(id){var action;action=this.groupSaveAction(id);if(action){return action.querySelector("button");}};Popover.prototype.groupSaveActions=function(){var popover;popover=this.browser.getPopover();return popover.querySelectorAll(".action.group-save");};Popover.prototype.readSoonAction=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.read-soon");};Popover.prototype.readSoonActionSavedAt=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.read-soon .description");};Popover.prototype.readSoonActionButton=function(){return this.readSoonAction().querySelector("button");};Popover.prototype.archiveAction=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.archive");};Popover.prototype.archiveActionButton=function(){return this.archiveAction().querySelector("button");};Popover.prototype.openInRefind=function(){return this.browser.getCurrentURL((function(_this){return function(url){return _this.openUrl("https://refind.com/?url="+url+"&redirect=true");};})(this));};Popover.prototype.openInRefindLinks=function(){var popover;popover=this.browser.getPopover();return popover.querySelectorAll(".open-in-refind-link");};Popover.prototype.createCollection=function(){return this.browser.getCurrentURL((function(_this){return function(url){return _this.openUrl("https://refind.com/?url="+url+"&collection=create");};})(this));};Popover.prototype.createCollectionAction=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".action.create-collection");};Popover.prototype.addMessagesEventListener=function(){var el,els,i,len,results1;els=this.allLinkChatActions();if(els.length>0){results1=[];for(i=0,len=els.length;i<len;i++){el=els[i];el.addEventListener("click",this.linkChatAction);results1.push(el.style.cursor="pointer");}return results1;}};Popover.prototype.addShareEventListener=function(){var el;el=this.shareLink();if(el){el.addEventListener("click",this.share);el.style.cursor="pointer";}el=this.sendLink();if(el){el.addEventListener("click",this.send);el.style.cursor="pointer";}el=this.shareTwitterLink();if(el){el.addEventListener("click",this.shareTwitter);el.style.cursor="pointer";}el=this.shareFacebookLink();if(el){el.addEventListener("click",this.shareFacebook);return el.style.cursor="pointer";}};Popover.prototype.groupSaveButtonClick=function(event){var action;action=$(event.target).parents(".action.group-save")[0];return this.groupSave(action,(function(_this){return function(response){_this.handleFeedback(response);if(response.success){_this.someData(response);_this.replaceCachedGroupsData(response);_this.setUIGroupSaved(response);return _this.showShare();}};})(this));};Popover.prototype.addGroupEventListeners=function(){var button,el,els,i,len,results1;els=this.groupSaveActions();if(els.length>0){results1=[];for(i=0,len=els.length;i<len;i++){el=els[i];button=$(el).find("button")[0];button.removeEventListener("click",this.groupSaveButtonClick);button.addEventListener("click",this.groupSaveButtonClick);results1.push(button.style.cursor="pointer");}return results1;}};Popover.prototype.addEventListeners=function(){var body,el,els,popover;popover=this.browser.getPopover();window.tagsInstallEventHandlers(popover.querySelector("body"));body=popover.querySelector("body");body.addEventListener("keydown",(function(_this){return function(event){var ctrlKeyDown,key;key=event.key;ctrlKeyDown=key==="Meta"||key==="Control"||key==="Alt"||key==="Shift";if(!ctrlKeyDown){return $(".tag-input").focus();}};})(this));el=this.showToolbarLink();if(el){el.addEventListener("click",(function(_this){return function(){_this.setToolbarEnabled(true,true);return _this.modifyDomainBlacklist(false);};})(this));}el=this.saveActionButton();if(el){el.addEventListener("click",this.save);}el=this.readSoonActionButton();if(el){el.addEventListener("click",this.readSoon);}el=this.createCollectionAction();if(el){el.addEventListener("click",this.createCollection);}this.addShareEventListener();this.addMessagesEventListener();els=this.openInRefindLinks();if(els){els.forEach((function(_this){return function(el){el.addEventListener("click",_this.openInRefind);return el.style.cursor="pointer";};})(this));}el=this.saveSelectedTextButton();if(el){el.addEventListener("click",this.saveSelectedText);el.style.cursor="pointer";}return this.installAnchorEventListeners(popover.body);};Popover.prototype.installAnchorEventListeners=function(scope){return this.browser["with"](this.browser.safari,(function(_this){return function(){var action,i,len,ref,results1;ref=scope.querySelectorAll(".anchor-action");results1=[];for(i=0,len=ref.length;i<len;i++){action=ref[i];results1.push(action.addEventListener("click",function(event){var target;event.preventDefault();target=$(event.target);if(target.attr("href")){return _this.openUrl(target.attr("href"));}else{return _this.openUrl(target.parent().attr("href"));}}));}return results1;};})(this));};Popover.prototype.openUrl=function(url){this.browser.openURL(url);return this.browser.hidePopover(this);};Popover.prototype.allLinkChatActions=function(){var popover;popover=this.browser.getPopover();return popover.querySelectorAll(".action-link-chat");};Popover.prototype.linkChatAction=function(){if(this.data.comment_url){return this.openUrl(this.data.comment_url);}};Popover.prototype.shareLink=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".share-link");};Popover.prototype.share=function(){if(this.data.share_url){return this.openUrl(this.data.share_url);}};Popover.prototype.sendLink=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".send-link");};Popover.prototype.send=function(){if(this.data.share_url){return this.openUrl(this.data.share_url);}};Popover.prototype.shareTwitterLink=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".share-link-twitter");};Popover.prototype.shareTwitter=function(){if(this.data.share_twitter_url){return this.openUrl(this.data.share_twitter_url);}};Popover.prototype.shareFacebookLink=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".share-link-facebook");};Popover.prototype.shareFacebook=function(){if(this.data.share_facebook_url){return this.openUrl(this.data.share_facebook_url);}};Popover.prototype.saveSelectedTextButton=function(){var popover;popover=this.browser.getPopover();return popover.querySelector(".save-text-input");};Popover.prototype.saveSelectedText=function(){return this.browser.getCurrentURL((function(_this){return function(url){return _this.browser.getCurrentSelection(function(selectedText){var data,el,error,feedback,openInRefindLink,parent,text;if(!selectedText||selectedText.length<1){error={title:"Â¯\\_(ãƒ„)_/Â¯",message:"To highlight text on Refind, select text on the page with your mouse and click the button again.",cta:null};feedback={error:error};return _this.showDialog(feedback);}else{data={url:url,content:selectedText,highlighted:true};_this.browser.sendFromPopover("add_note",data);el=_this.saveSelectedTextButton();el.style.cursor="default";el.setAttribute("value","Highlighted");el.disabled=true;parent=el.parentNode;openInRefindLink=document.createElement("a");text=document.createTextNode("View");openInRefindLink.appendChild(text);openInRefindLink.addEventListener("click",_this.openInRefind);return parent.appendChild(openInRefindLink);}});};})(this));};Popover.prototype.setSaveExplainer=function(type){var explainerDiv,popover;popover=this.browser.getPopover();explainerDiv=popover.querySelector(".dialog.save .explainer");return this.replaceNode(explainerDiv,(function(_this){return function(node){var text;text=type==="saving"?"Savingâ€¦":"Save link";return node.textContent=text;};})(this));};Popover.prototype.domainFrom=function(url){var hostname,parser;parser=document.createElement("a");parser.href=url;hostname=parser.hostname;return hostname.split(".").slice(-2).join(".");};Popover.prototype.replaceNode=function(node,callback){var child;while(child=node.firstChild){node.removeChild(child);}if(callback){return callback(node);}};return Popover;})();window.Refind=Refind=(function(){function Refind(root1){var specific_browser;this.root=root1;this.debug=bind(this.debug,this);this.send=bind(this.send,this);this.setupPopoverListeners=bind(this.setupPopoverListeners,this);this.setupBackgroundInsertListeners=bind(this.setupBackgroundInsertListeners,this);this.setupInsertListeners=bind(this.setupInsertListeners,this);this.setupSearchListeners=bind(this.setupSearchListeners,this);this.setupBackgroundSearchListeners=bind(this.setupBackgroundSearchListeners,this);this.getLinkInfo=bind(this.getLinkInfo,this);this.settingsData=bind(this.settingsData,this);this.setupAPIListeners=bind(this.setupAPIListeners,this);this.setupInserts=bind(this.setupInserts,this);this.setupSearchEngines=bind(this.setupSearchEngines,this);this.setupWatermark=bind(this.setupWatermark,this);this.setupPopover=bind(this.setupPopover,this);this.setupBackground=bind(this.setupBackground,this);this.from=bind(this.from,this);this.resetSettings=bind(this.resetSettings,this);Refind.instance=this;this.url=new URLs(this.root);specific_browser=new Browser(this.url);this.browser=new BrowserAdapter(specific_browser,this.url);this.api=new API(this.url,this.browser);this.resetSettings();}Refind.prototype.resetSettings=function(){this.debug("RESETTING SETTINGS",document.environment);return this.settings=new Settings(this.api,this.browser);};Refind.prototype.from=function(root){return this.browser.refindInstanceFrom(this,root);};Refind.prototype.setupBackground=function(){this.context="background";this.debug("Setting up",document.environment);return this.browser.setupBackground(this);};Refind.prototype.setupPopover=function(){this.context="popover";this.debug("Setting up",document.environment);this.popover=new Popover(this.browser,this.api,this.root);return this.popover.setup(this);};Refind.prototype.setupWatermark=function(){this.context="watermark";this.debug("Setting up",document.environment);this.debug("Adding Watermark in Refind.");return this.browser.addWatermark();};Refind.prototype.setupSearchEngines=function(){this.context="search engines";this.debug("Setting up",document.environment);this.google=new SearchEngines.Google(this.browser);return this.google.setup(this);};Refind.prototype.setupInserts=function(){this.context="inserts";this.debug("Setting up",document.environment);this.toolbar=new Toolbar(this.browser,"50px",false);return this.toolbar.setup(this);};Refind.prototype.setupAPIListeners=function(local){this.browser.on("save_link",this.api.saveLink,{local:local});this.browser.on("group_save_link",this.api.groupSaveLink,{local:local});this.browser.on("add_read_soon_url",this.api.addReadSoonUrl,{local:local});this.browser.on("unsave_link",this.api.unsaveLink,{local:local});this.browser.on("add_read_soon",this.api.addReadSoon,{local:local});this.browser.on("archive_read_soon",this.api.archiveReadSoon,{local:local});this.browser.on("delete_read_soon",this.api.deleteReadSoon,{local:local});this.browser.on("add_note",this.api.addNote,{local:local});this.browser.on("share_link",this.api.shareLink,{local:local});this.browser.on("save_tag",this.api.saveTag,{local:local});this.browser.on("remove_tag",this.api.removeTag,{local:local});this.browser.on("link_open",this.api.openLink,{local:local});this.browser.on("update_check",this.browser.updateCheck);this.browser.on("reset_settings",this.resetSettings,{local:local});this.browser.on("settings_data",this.settingsData,{local:local});return this.browser.on("maybe_link_data",this.getLinkInfo,{local:local});};Refind.prototype.settingsData=function(_,callback){return this.settings.fetchIfNeeded((function(_this){return function(settings){return callback({default_action:_this.settings.defaultAction,groups:_this.settings.groups});};})(this));};Refind.prototype.getLinkInfo=function(data,callback){data.groups_etag=this.settings.groupsEtag;return this.api.getLinkInfo(data,(function(_this){return function(response){if(response.invalidate_cache){_this.settings.invalidate(response.groups_etag,function(){});}return callback&&callback(response);};})(this));};Refind.prototype.setupBackgroundSearchListeners=function(local){return this.browser.on("search",(function(_this){return function(data,thing){return _this.settings.fetchIfNeeded(function(){var resultURL;if(_this.settings.searchAllowed){data={search_engine:data.search_engine,query:decodeURIComponent(data.query),result_urls:(function(){var i,len,ref,results1;ref=data.result_urls;results1=[];for(i=0,len=ref.length;i<len;i++){resultURL=ref[i];results1.push(decodeURIComponent(resultURL));}return results1;})()};return _this.api.search(data,function(response){return _this.browser.send("results",response,thing);});}});};})(this),{local:local});};Refind.prototype.setupSearchListeners=function(engine,local){if(!this.browser.isPrivate()){this.browser.on("maybe_search",(function(_this){return function(data){return _this.browser.send("search",data);};})(this),{local:true});this.browser.on("results",(function(_this){return function(response){return engine.renderResults(response);};})(this),{local:local});return this.browser.on("safari_get_selected_text",(function(_this){return function(){return _this.browser.getCurrentSelection(function(selection){return _this.browser.send("safari_selected_text",selection);});};})(this),{local:local});}};Refind.prototype.setupInsertListeners=function(engine,local){if(!this.browser.isPrivate()){this.browser.on("toolbar_html",(function(_this){return function(response){return engine.toolbarHTML(response.html);};})(this),{local:local});this.browser.on("maybe_toolbar",(function(_this){return function(data){return _this.browser.send("toolbar",data);};})(this),{local:true});this.browser.on("link_data_results",(function(_this){return function(response){if(response.origin==="toolbar"){return engine.toolbarData(response);}else{if(response.origin==="popover"){return _this.browser.send("popover_link_data_results",response);}}};})(this),{local:local});this.browser.on("maybe_link_data",(function(_this){return function(data){return _this.browser.send("link_data",data);};})(this),{local:true});this.browser.on("api_call_results",(function(_this){return function(data){var fn,params,response;fn=data.fn;params=data.params;response=data.response;return engine.apiCallResults(fn,params,response);};})(this),{local:local});this.browser.on("settings_toolbar_enabled_results",(function(_this){return function(data){return engine.setSettings(data);};})(this),{local:local});return this.browser.on("toolbar_shown",(function(_this){return function(){return _this.browser.send("toolbar_shown_results",{shown:engine.shown});};})(this),{local:local});}};Refind.prototype.setupBackgroundInsertListeners=function(local){this.browser.on("settings_toolbar_enabled",(function(_this){return function(data,thing){return _this.settings.fetchIfNeeded(function(settings){return _this.settings.sendSettings(thing,_this.browser);});};})(this),{local:local});this.browser.on("toolbar",(function(_this){return function(data,thing){return _this.settings.fetchToolbar(function(data){return _this.browser.send("toolbar_html",data,thing);});};})(this),{local:local});this.browser.on("link_data",(function(_this){return function(data,thing){return _this.api.getLinkInfo(data,function(response){return _this.browser.send("link_data_results",response,thing);});};})(this),{local:local});this.browser.on("settings_toolbar_session_enabled",(function(_this){return function(data,thing){return _this.settings.fetchIfNeeded(function(settings){var enabled;enabled=data.enabled;return _this.settings.setToolbarSessionEnabled(enabled);});};})(this),{local:local});return this.browser.on("api_call",(function(_this){return function(data,thing){var enabled,fn,func,params;fn=data.fn;params=data.params;func=_this.api[fn];if(func){func(params,function(response){return _this.browser.send("api_call_results",{fn:fn,params:params,response:response},thing);});}switch(fn){case"setToolbarEnabled":enabled=params.state;_this.settings.setToolbarEnabled(enabled,params.force);if(enabled){return _this.settings.setToolbarSessionEnabled(enabled);}break;case"blacklistDomain":return _this.settings.modifyDomainBlacklist(params.domain,params.add);}};})(this),{local:local});};Refind.prototype.setupPopoverListeners=function(popover,local){this.browser.on("toolbar_shown_results",popover.toolbarShownResults,{local:local});return this.browser.on("popover_link_data_results",popover.linkData,{local:local});};Refind.prototype.send=function(name,data){return this.browser.send(name,data);};Refind.prototype.debug=function(){if(this.url.isDebug()){Array.prototype.unshift.call(arguments,(this.context!=null)&&this.context||"(Context not defined)");return this.browser.debug.apply(this.browser,arguments);}};return Refind;})();Refind.debug=function(){return Refind.instance.debug(arguments);};Refind["for"]=function(root){if(Refind.instance!=null){Refind.instance.from(root);}else{new Refind(root);}return Refind.instance;};}).call(this);