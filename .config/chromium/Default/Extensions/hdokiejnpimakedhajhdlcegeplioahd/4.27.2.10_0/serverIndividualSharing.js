LPServer.sharing=LPServer.sharing||{},LPServer.sharing.individual=function(){var e=function(){var e={noemailspecified:function(e,r){r.error(LPServer.ext.translate("Please enter at least one email and try again."))},usernameisnotvalidemail:function(e,r){var a=LPServer.getRecordsFromResponse(e,"email",LPServer.getAttrInt(e,"numinvalid",0));r.error(LPServer.ext.translate("The following emails are invalid: %1",a.join(", ")))},toomanyemails:function(e,r){var a=LPServer.getAttrInt(e,"numexcess");"1"===a?r.error(LPServer.ext.translate("You are trying to share with too many people.  Please remove at least %1 email and try again.",a)):r.error(LPServer.ext.translate("You are trying to share with too many people.  Please remove at least %1 emails and try again.",a))},cantsharewithself:function(e,r){r.error(LPServer.ext.translate("You can not share with yourself."))}},r=function(e,r,a){this.email=e,this.pubkey=r,this.encpass=a},a=function(e,r){this.aid=e.getAttribute("aid"),this.username=LPServer.ext.decrypt(e.getAttribute("username"),r),this.password=LPServer.ext.decrypt(e.getAttribute("password"),r),this.name=LPServer.ext.decrypt(e.getAttribute("name"),r),this.grouping=LPServer.ext.decrypt(e.getAttribute("grouping"),r),this.extra=LPServer.ext.decrypt(e.getAttribute("extra"),r),this.attachkey=LPServer.ext.decrypt(e.getAttribute("attachkey"),r),this.afids=this.parseFields(e.getAttribute("afids"),r),this.otherafids=this.parseFields(e.getAttribute("otherafids"),r),this.accts_notes=this.parseFields(e.getAttribute("accts_notes"),r),this.accts_usernames=this.parseFields(e.getAttribute("accts_usernames"),r),this.accts_passwords=this.parseFields(e.getAttribute("accts_passwords"),r),this.template=e.getAttribute("template")},t,s;a.prototype.parseFields=function(e,r){var a=[];if(e)for(var t=0,s=(e=e.split("^")).length;t<s;++t){var n=e[t];""!==n&&(n=e[t].split("&"),a.push({name:n[0],value:LPServer.ext.decrypt(n[1],r)}))}return a},a.prototype.encrypt=(t=function(e,r){return e?LPServer.ext.encryptCBC(e,r):""},s=function(e,r){for(var a=JSON.parse(JSON.stringify(e)),s=0,n=a.length;s<n;++s)a[s].value=t(a[s].value,r);return a},function(e){return{username:t(this.username,e),password:t(this.password,e),name:t(this.name,e),grouping:t(this.grouping,e),extra:t(this.extra,e),attachkey:t(this.attachkey,e),afids:s(this.afids,e),otherafids:s(this.otherafids,e),accts_notes:s(this.accts_notes,e),accts_usernames:s(this.accts_usernames,e),accts_passwords:s(this.accts_passwords,e)}});var n=function(e,r,a,t){for(var s=0,n=a.length;s<n;++s)e[r+t+s+"name"]=a[s].name,e[r+t+s+"value"]=a[s].value;e[r+"num"+t]=a.length},i=function(e,r){var a=LPServer.getAttrInt(e,"numemails",0);1===a?r.success(LPServer.ext.translate("Share sent to %1.",LPServer.getAttr(e,"email0",""))):r.success(LPServer.ext.translate("Share sent to %1 recipients.",a))},c=function(e,r,a){for(var t={cmd:"share",sharemessage:"",giveshare:a.params.giveshare?1:0,numemails:e.length,numaids:r.length,fromrole:0,sharesyncpush:0,shareautopull:0,reportname:[]},s=0,c=e.length;s<c;++s){var o=e[s],l=LPServer.ext.createRandomHexString(64),m=LPServer.ext.hex2bin(l),p=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(p,o.pubkey);var u=p.encrypt(m),h="email"+s;t[h]=o.email,t["sharekeyenchex"+s]=u,t["sharekeyenchexsig"+s]="",o.encpass&&(t["encpass"+s]=o.encpass);for(var v=0;v<r.length;++v){var d=r[v],g=d.encrypt(m);1==a.params.logname&&t.reportname.push({aid:d.aid,name:d.name});var S=h+"aid"+v;t[S]=d.aid,t[S+"username"]=g.username,t[S+"password"]=g.password,t[S+"name"]=g.name,t[S+"grouping"]=g.grouping,t[S+"extra"]=g.extra,t[S+"attachkey"]=g.attachkey,t[S+"template"]=d.template,n(t,S,g.afids,"afid"),n(t,S,g.otherafids,"otherafid"),n(t,S,g.accts_notes,"accts_notes"),n(t,S,g.accts_usernames,"accts_usernames"),n(t,S,g.accts_passwords,"accts_passwords")}}LPServer.xmlRequest({url:"showshare.php",data:t,callbacks:{shareok:i},userSupplied:a})},o=function(e,r){for(var t=[],s=LPServer.getNodes(e,"encdata"),n=0,i=s.length;n<i;++n)t.push(new a(s[n],r));return t},l=function(e,r){for(var a=[],t=0,s=e.length;t<s;++t){var n=e[t];n&&a.push({email:n,reason:r})}return a},m=function(e,a){var t=LPServer.getAttrInt(e,"numsharesok",0);if(t>0){for(var s=[],n=0;n<t;++n){var i=LPServer.getAttr(e,"emailok"+n,""),m=LPServer.getAttr(e,"emailokpubkeyhex"+n,""),p=LPServer.getAttr(e,"emailencp"+n,"");s.push(new r(i,m,p))}c(s,o(e,a.params.key),a)}var u=LPServer.getAttrInt(e,"numsharesdne",0);u>0&&a.callbacks&&a.callbacks.invite&&a.callbacks.invite({emails:LPServer.getRecordsFromResponse(e,"emaildne",u)});var h=LPServer.getAttr(e,"sharingwithself",""),v=LPServer.getAttrInt(e,"numsharesinv",0),d=LPServer.getAttrInt(e,"numsharesuns",0),g=LPServer.getAttrInt(e,"numsharesspa",0),S=LPServer.getAttrInt(e,"numsharesres",0);if((h||v>0||d>0||g>0||S>0)&&a.callbacks&&a.callbacks.problems){var P=l([h],LPServer.ext.translate("You can not share with yourself."));P=(P=(P=(P=P.concat(l(LPServer.getRecordsFromResponse(e,"emailinv",v),LPServer.ext.translate("Invalid email address.")))).concat(l(LPServer.getRecordsFromResponse(e,"emailuns",d),LPServer.ext.translate("The user must login to LastPass at least once to permit sharing.")))).concat(l(LPServer.getRecordsFromResponse(e,"emailspa",g),LPServer.ext.translate("The user does not want to receive emails from LastPass.")))).concat(l(LPServer.getRecordsFromResponse(e,"emailres",S),LPServer.ext.translate("Sharing is restricted by a LastPass Enterprise policy."))),a.callbacks.problems(P)}0===t&&a.error()};return function(r){r.callbacks=LPServer.extend(r.callbacks,e);for(var a={cmd:"getclientdata",shareeusername:r.params.emails,numaids:r.params.aids.length},t=0,s=r.params.aids.length;t<s;++t)a["aid"+t]=r.params.aids[t];LPServer.xmlRequest({url:"showshare.php",data:a,callbacks:{getclientdataack:m},userSupplied:r})}}(),r=(a=function(e,r){r.success(LPServer.ext.translate("Share revoked from %1",r.params.email))},function(e){LPServer.xmlRequest({url:"showshare.php",data:{cmd:"unshare",aid:e.params.id,username:e.params.email},callbacks:{unshareok:a},userSupplied:e})}),a,t=(s=function(e,r){r.success(LPServer.ext.translate("Share accepted."))},n=function(e,r,a){var t=LPServer.ext.decrypt(e,r);return t?LPServer.ext.encryptCBC(t,a):""},i=function(e){var r=e.params.key,a=e.params.pendingShareKey,t=e.params.pendingShare,i={cmd:"acceptshare",msgtosharer:"",aid:t.id,newgroup:LPServer.ext.encryptCBC(e.params.group,r),name:n(t.sharename,a,r),grouping:n(t.sharegroup,a,r),username:n(t.username,a,r),password:n(t.password,a,r),extra:n(t.extra,a,r),attachkey:n(t.attachkey,a,r)};i.newname=e.params.name?LPServer.ext.encryptCBC(e.params.name,r):i.name;var c=t.save_all?"otherafid":"afid";for(var o in t.shareafids){var l=t.shareafids[o];l&&(l=n(l,a,r)),i[c+o]=l}LPServer.xmlRequest({url:"showacceptshare.php",data:i,callbacks:{acceptshareok:s},userSupplied:e})},function(e){e.params.pendingShare?i(e):e.params.id&&u(LPServer.extend({},e,{params:{id:e.params.id},success:function(r){e.params.pendingShare=r.pendingShare;var a=new LPServer.ext.RSAKey;LPServer.ext.parsePrivateKey(a,LPServer.ext.extractPrivateKey(r.privateKey,e.params.key)),e.params.pendingShareKey=a.decrypt(e.params.pendingShare.sharekeyenchex),i(e)}}))}),s,n,i,c,o,l,m,p,u=function(e){var r=e.params&&e.params.id?{aid:e.params.id}:{};e.params.url&&h(e.params.url)&&(r.from="acceptshare",r.confirm_token=v(e.params.url)),LPServer.jsonRequest({url:"getReceivedShareInfo.php",data:r,userSupplied:e})},h=function(e){return!!e.match(/acceptshare=/gi)},v=function(e){var r=e.match(/confirm_token=[^&]*/gi);return r?r[0].split("=")[1]:""};return{shareItems:e,unshareItem:r,acceptShare:t,rejectShare:(o=function(e,r){r.success(LPServer.ext.translate("Share rejected."))},function(e){LPServer.xmlRequest({url:"showacceptshare.php",data:{cmd:"rejectshare",aid:e.params.id},callbacks:{rejectshareok:o},userSupplied:e})}),inviteFriends:(m=function(e,r){if(r.callbacks&&r.callbacks.problems){var a=[],t=LPServer.getAttrInt(e,"numalready",0);if(t>0){var s=LPServer.getRecordsFromResponse(e,"emailalready",t).join(", ");a.push(LPServer.ext.translate("You have already invited the following friends: %1. Please send them a reminder using your personal email as the email invitation sent by LastPass might not have reached them.",s))}var n=LPServer.getAttrInt(e,"numspam",0);if(n>0){var i=LPServer.getRecordsFromResponse(e,"emailspam",n).join(", ");a.push(LPServer.ext.translate("The following friends have marked your invitations as spam: %1.",i))}a.length>0&&r.callbacks.problems(a)}var c=LPServer.getAttrInt(e,"numsent",0);1===c?r.success(LPServer.ext.translate("%1 was invited. We will send you a notification email when they join LastPass so you can retry sharing your data with them.",LPServer.getAttr(e,"emailsent0",""))):c>1?r.success(LPServer.ext.translate("%1 friends were invited. We will send you a notification email when any of them join LastPass so you can retry sharing your data with them.",c)):r.error()},function(e){for(var r={cmd:"invite",numemails:e.params.emails.length},a=0,t=e.params.emails.length;a<t;++a)r["email"+a]=e.params.emails[a];LPServer.xmlRequest({url:"showshare.php",data:r,callbacks:{inviteack:m},userSupplied:e})}),getSentShareData:function(e){LPServer.jsonRequest({url:"getSentShareInfo.php",data:e.params&&e.params.id?{aid:e.params.id}:null,userSupplied:e})},getReceivedShareData:u}}();
//# sourceMappingURL=sourcemaps/serverIndividualSharing.js.map
