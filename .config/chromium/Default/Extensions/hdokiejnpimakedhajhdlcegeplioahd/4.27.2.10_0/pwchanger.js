function PWCHANGER(){var n=2,t="",a=new Array,o="",i="",r="",s="",u="",c="",d=0,f=0,p="",y="",h=new Array,_=100100,g=10,k="",w=[];function m(){return"undefined"!=typeof $?$.ajax:LPPlatform.doAjax}function v(e,n,a,o,i,r,s){C(function(){I(function(){u()},r)},r);var u=function(){var u=void 0!==n&&null!=n&&""!=n?{wxusername:e,wxhash:n}:{};void 0!==s&&null!=s&&""!=s&&(u.vendor=s);var c=t+"getaccts.php?changepw=1&changepw2=1&includersaprivatekeyenc=1&changeun="+(e!=a?encodeURIComponent(a):"")+"&resetrsakeys="+(o?"1":"0")+"&includeendmarker=1",d;"undefined"!=typeof g_recovery_uid&&(c+="&recovery_uid="+encodeURIComponent(g_recovery_uid)),m()({url:c,type:"POST",data:u,timeout:3e5,success:"function"==typeof i?i:null,error:"function"==typeof r?r:null})}}function b(e,n,a,o,i){""===a&&o();var r=p||token,s;m()({url:t+"lmiapi/one-time-password",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({masterPasswordHash:a}),headers:{"X-CSRF-TOKEN":r},success:function(t){if("object"==typeof t.oneTimePasswords)if(w=[],0!==t.oneTimePasswords.length){var r=[];try{for(var s=fix_username(h.newemail),u=0;u<t.oneTimePasswords.length;u++){var c=t.oneTimePasswords[u],d={},l=dec(c.encryptedOneTimePassword,e),f=AES.hex2bin(l),p=make_lp_hash(s,f),y=make_lp_key(s,f);c.oneTimePasswordHash=p,c.randomEncryptedKey=enc(AES.bin2hex(e),y),d.encryptedOneTimePassword=enc(l,n),d.randomEncryptedKey=enc(AES.bin2hex(n),y),d.oneTimePasswordHash=p,r.push(d),w.push(c)}}catch(e){return void("function"==typeof i&&i("OTP Encryption failed"))}P(r,a,o,i)}else"function"==typeof o&&o();else"function"==typeof i&&i("Invalid one time password response")},error:function(e){"function"==typeof i&&i("GET one time passwords failed")}})}function T(e){0!==w.length?P(w,pwhash,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function P(e,n,a,o){""===n&&a();var i=JSON.stringify({oneTimePasswords:e,masterPasswordHash:n}),r=p||token,s;m()({url:t+"lmiapi/one-time-password/update",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":r},data:i,dataType:"json",success:a,error:function(){"function"==typeof o&&o("POST new one time passwords failed")}})}function E(e,n,a,o){var i=p||token,r;m()({url:t+"lmiapi/authenticator/backup",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":i},success:function(t){var i;try{k=t.userData;var r=dec(t.userData,e);i=enc(r,n)}catch(e){return void("function"==typeof o&&o("Encryption failed"))}S(i,a,o)},error:function(e){e.status&&404==e.status?"function"==typeof a&&a():"function"==typeof o&&o("GET new LP cloud backup failed")}})}function A(e){k?S(k,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function S(e,n,a){var o=JSON.stringify({userData:e}),i=p||token,r;m()({url:t+"lmiapi/authenticator/backup",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":i},data:o,dataType:"json",success:n,error:function(){"function"==typeof a&&a("POST new LP cloud backup failed")}})}function O(e){var n=null,t=h.callback;"function"==typeof t&&t(2,!1,!1,n)}function x(){try{if(2==n){a=h.reencrypt.split("\n"),"number"==typeof g_target_key_iterations&&(_=g_target_key_iterations,"undefined"!=typeof g_key_iterations&&g_key_iterations!=g_target_key_iterations&&(h.iterationschange="1")),u=h.newkey||make_lp_key_iterations(fix_username(h.newemail),h.newpassword,_),o+=a[0]+"\n";var e=a[1];if(""!=e){var p=rsa_extract_privatekey(e,h.oldkey);""==p&&""!=h.oldkey1&&(p=rsa_extract_privatekey(e,h.oldkey1)),""==p?i="":(i=rsa_encrypt_privatekey(p,u),p=null),r=SHA256(AES.bin2hex(u).toUpperCase()),s=SHA256(i)}}if(void 0===a.length)return void h.callback(2,!1,!1,"F2 : internal error");var y,k,w=!1;try{enc(" ",u)&&(w=!0)}catch(e){}for(var v=n+3;n<a.length&&n<v;++n){var T,P=a[n].replace(/\r\n|\r|\n/g,"").split("\t");if(l=P[0],"endmarker"!=l){var A=void 0!==P.length&&P.length>=2&&"0"==P[1];if(void 0!==l.length&&l.length){var S=null;if(w)try{y=dec(l,h.oldkey),k=enc(y,u)}catch(e){S=e}if(!w||null!=S||!AES.ok(k)||0==k.length||null==y||void 0===y.length||0==y.length){if(!A){if(w)null!=(y=dec(l,u))&&void 0!==y.length&&0!=y.length||(c+="enc: "+l+" decrypted:  reencrypted to: "+k+(null==S?"":" : EXCEPTION_A!")+"\n");else{var C=void 0===u.length?"undefined":u.length;c+="encrypting <space> using m_newkey (m_newkey.length="+C+") resulted in EXCEPTION_B!\n"}d++}k=w?l:""}A||f++,o+=l+":"+k+"\n","function"==typeof h.status&&h.status(1,(n-1)/(a.length-2))}}else h.foundendmarker=!0}if(n<a.length)return void setTimeout(function(){x()},0);if(!h.foundendmarker)return void("function"==typeof h.callback&&h.callback(2,!1,!1,"D : Data download not complete"));if(void 0!==g&&g||(g=10),""!=c&&d>=f/100*g){var I={errors:c,username:h.oldemail},R;return m()({url:t+"debug.php",data:I,type:"POST",timeout:6e5,success:function(e){},error:function(e,n){}}),void("function"==typeof h.callback&&h.callback(3,null,null,"E : "+c))}"function"==typeof tracelog&&tracelog("Re encryption finished."),E(h.oldkey,u,function(){h.iterationschange?b(h.oldkey,u,h.oldpwhash,j,O):j()},O)}catch(e){h.callback(2,!1,!1,"F : "+e.message)}}this.hashMigration=function(e,n,a,o,i,r,s,u,c){if(t=r,p=s,_=u,g=0,"function"!=typeof c&&(c=function(){}),e!==o){var d=function(e,n,t,a){0===e?c(!0):c(!1,a)},l,f;v(a,n,a,!1,function(t){if("string"==typeof t)if("usernametaken"!=t){var r={oldkey:e,oldkey1:"",oldpwhash:n,oldemail:a,newemail:a,newkey:o,newpwhash:i,callback:d,reencrypt:t,status:status,foundendmarker:!1,iterationschange:"1",hashmigration:"1"};h=r,setTimeout(function(){x()},0)}else c(!1,"Username taken or deleted during hash migration");else c(!1,"Invalid response")},function(){c(!1,"Error retrieving accounts data during hash migration")})}else c(!1,"Hash migration already happened? Maybe stale extension data")},this.changepw=function(n,a,o,i,r,s,u,c,d,l,f,_,k,w,m){var b=void 0!==k?k:"",T,P;void 0!==w&&w&&(g=w),void 0!==f&&null!=f||(f=""),"function"!=typeof u&&(u=function(){}),p=f,y=_,t=c,"function"==typeof d&&d(0,0),v(o,a,i,s,function(e){if("string"==typeof e)if("usernametaken"!=e){"function"==typeof d&&d(0,1);var t={oldkey:n,oldkey1:b,oldpwhash:a,oldemail:o,newemail:i,newpassword:r,callback:u,reencrypt:e,status:d,foundendmarker:!1};m&&(t.ks="true"),h=t,setTimeout(function(){x()},0)}else u(1,!1,!1,"B : Username Taken");else u(4,!1,!1,"A : Invalid Response")},function(n){u(2,!1,!1,"C : "+textstatus+" suberror="+e)},l)};var C=function(e,n){var a;Array.isArray(window.g_su_pubkeys)&&Array.isArray(window.g_su_uids)?e():m()({url:t+"lmiapi/users/me/publicsharingkeys",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":p},success:function(n){window.g_su_pubkeys=n.map(function(e){return e.publicSharingKey}),window.g_su_uids=n.map(function(e){return e.userId}),e&&e()},error:function(e){O("Cannot GET sharing keys"),n&&n()}})},I=function(e,n){var a;Array.isArray(window.g_lu_pubkeys)&&Array.isArray(window.g_lu_uids)?e():(window.g_lu_pubkeys=[],window.g_lu_uids=[],m()({url:t+"lmiapi/emergency-access/sharees",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":p},success:function(n){n.forEach(function(e){window.g_lu_pubkeys.push(e.publicSharingKey),window.g_lu_uids.push(e.userId)}),e&&e()},error:function(t){404!==t.status?(O("Request for emergency access keys failed"),n&&n()):e()}}))};function j(){"function"==typeof tracelog&&tracelog("Update data to server.");var e=h.newpwhash||make_lp_hash_iterations(u,h.newpassword,_),l={reencrypt:o,newprivatekeyenc:i,newuserkeyhexhash:r,newprivatekeyenchexhash:s,newpasswordhash:e,pwupdate:"1",email:h.newemail,token:p,encrypted_username:encecb(h.newemail,u),origusername:h.oldemail,key_iterations:_};if(h.iterationschange&&(l.iterationschange=h.iterationschange),h.hashmigration&&(l.hashmigration=h.hashmigration,l.ks=!0),"undefined"!=typeof g_is_recovery&&g_is_recovery&&(l.is_recovery="1"),void 0!==h.oldpwhash&&null!=h.oldpwhash&&""!=h.oldpwhash&&(l.wxusername=h.oldemail,l.wxhash=h.oldpwhash),void 0!==h.ks&&h.ks&&(l.ks="true"),void 0!==y&&null!=y&&(l.password_hint=y),"undefined"!=typeof g_su_pubkeys&&null!=g_su_pubkeys&&g_su_pubkeys.length){for(var g=!1,k=0,w=0;w<g_su_pubkeys.length;w++)if(""!=g_su_pubkeys[w]){var v=new RSAKey;parse_public_key(v,g_su_pubkeys[w])&&(l["sukey"+k]=v.encrypt(AES.bin2hex(u)),l["suuid"+k]=g_su_uids[w],g=!0,k++)}if(l.sukeycnt=k,0==g&&"function"==typeof h.callback)return void h.callback(2,!1,!1,"G : Please tell your administrator that all users marked as Administrators must log into a browser extension once in order to properly setup account recovery.")}if("undefined"!=typeof g_lu_pubkeys&&null!=g_lu_pubkeys){var k=0;g_lu_pubkeys.forEach(function(e,n){if(e){var t=new RSAKey;parse_public_key(t,e)&&(l["lukey"+k]=t.encrypt(AES.bin2hex(u)),l["luuid"+k]=g_lu_uids[n],k++)}}),l.lukeycnt=k}"undefined"!=typeof g_recovery_uid&&(l.recovery_uid=g_recovery_uid),"undefined"!=typeof g_changeiterations&&1==g_changeiterations&&(l.iterationschange="1"),"undefined"!=typeof g_sapr_pwd&&"undefined"!=typeof g_sapr_newpwd&&(l.to_be_federated=1,l.fed_keyALP=g_sapr_keyALP,l.fed_keyLP=g_sapr_keyLP,l.fed_keyLPCheckHash=g_sapr_keyLPCheckHash,l.fed_fragmentId=g_sapr_fragmentId,l.fed_pwdlastset=g_sapr_lastPwdSet),"undefined"!=typeof g_oid_fragmentId&&(l.fedOId_fragmentId=g_oid_fragmentId);var b=h.callback,P=u,E=h.newemail,S=h.status,O;h=new Array,a=new Array,o="",n=2,u="",c="",d=0,f=0,"function"==typeof S&&S(2,0),m()({url:t+"settings.php",data:l,type:"POST",timeout:6e5,success:function(e,n){"function"==typeof S&&S(2,1),-1!=e.indexOf("pwchangeok")?"function"==typeof b&&b(0,P,E):e.indexOf("reusepass")>=0?A(function(){T(function(){b(2,!1,!1,"H : "+e.split("\n")[1])})}):0==e.indexOf("error\n")?A(function(){T(function(){b(2,!1,!1,e.split("\n")[1])})}):A(function(){T(function(){b(2,!1,!1,"I : An error occured")})})},error:function(e,n,t){A(function(){T(function(){"function"==typeof b&&b(2,!1,!1,"J : "+n+" suberror="+t)})})}})}}
//# sourceMappingURL=sourcemaps/pwchanger.js.map
