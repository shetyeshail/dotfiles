/* Copyright 2011 Google Inc. All Rights Reserved. */ (function(){var f="\" ' ( ) , - . / 0 1 2 : ? a about and are as be but com for from have i in is it like may more my next not of on search that the this to was when with you your".split(" "),l=!1,q={},r={},t=0,u=-1,v=-1,w=function(a){a=a.replace(/<[^>]*>/g,"");return a=a.replace(/[<>]/g,"")},x=function(a){a=w(a);return a=a.substring(0,100).toLowerCase()},y=function(a){for(var b=0,c=f.length;b<c;b++)if(a===f[b])return!0;return!1},z=function(a,b,c){"initialize"===a.type&&c({instanceId:t++})},A=function(a){"openOptionsPage"===
a.type&&chrome.tabs.create({url:chrome.runtime.getURL("options.html")})},B=function(a,b,c){"options"===a.type&&c({options:q})},F=function(a,b,c){if("fetch_raw"!==a.type&&"fetch_html"!==a.type)return!1;_gaq&&_gaq.push(["_trackEvent","lookup",a.type]);-1!==u&&v!==a.instanceId&&chrome.tabs.sendMessage(u,{type:"hide",instanceId:v});"fetch_raw"===a.type?(u=b.tab.id,v=a.instanceId):v=u=-1;var d=x(a.query),e=function(){var b={request:a,sanitizedQuery:d,dictRes:null,enDictRes:null,tranRes:null,tabLangTranRes:null,
tabLangTranReqTimedOut:!1,tabLang:null,numResponses:0,callback:c,incognito:!1};C(d,q.language,function(a){b.dictRes=a;D(b)});"en"!==q.language?C(d,"en",function(a){b.enDictRes=a;D(b)}):D(b);E(d,"auto",function(a){b.tranRes=a;D(b)});chrome.tabs.getSelected(null,function(a){b.incognito=a.incognito;var c=window.setTimeout(function(){console.assert(null===b.tabLangTranRes);b.tabLangTranReqTimedOut=!0;D(b)},800);chrome.tabs.detectLanguage(a.id,function(a){b.tabLangTranReqTimedOut||(window.clearTimeout(c),
"und"!==a?(b.tabLang="he"===a?"iw":a,E(d,b.tabLang,function(a){b.tabLangTranRes=a;D(b)})):D(b))})})};if(l)e();else{var n=function(b){l?e():10<b?c({eventKey:a.eventKey,sanitizedQuery:d}):window.setTimeout(function(){n(b+1)},200)};n(0)}return!0},C=function(a,b,c){var d=b;"en-uk"==b&&(d="en");var e=window["gdx.LANG_TO_CORPUS"][b];e||(e=b);a={path:"dictionaryextension/v1/knowledge/search",params:{term:a,language:d,corpus:e}};(e=window["gdx.CORPUS_TO_COUNTRY"][e])&&(a.params.country=e);gapi.client.request(a).execute(function(a){a=
G(a,"dictionaryData[0]");if(!a)return c(null);var b=function(a){if(!a.senseFamilies)return 0;a=a.senseFamilies;for(var b=a.length,c=0;c<a.length;c++)a[c].senses&&(b+=.1*a[c].senses.length);return b},d=function(a,c){return b(c)-b(a)};a.entries&&(a.entries=a.entries.sort(d));a.webDefinitions&&(a.hasWebDefinitions=!0);c(a)})},E=function(a,b,c){a="https://clients5.google.com/translate_a/t?client=dict-chrome-ex&sl="+b+"&tl="+q.language+"&q="+encodeURIComponent(a);var d=new XMLHttpRequest;d.open("GET",
a,!0);d.onload=function(){var a=null;if(200===this.status)try{a=JSON.parse(d.response)}catch(n){}return c(a)};d.send()},D=function(a){a.numResponses++;if(4===a.numResponses){var b=H(a.dictRes),c=b;"en"!==q.language&&(c=H(a.enDictRes));var d=I(a.tranRes,!0),e=I(a.tabLangTranRes,!0),n=q.language.toLowerCase();var g=!1;var p=null,k=null;e&&a.tabLang!==n?(g=!0,p=a.tabLangTranRes,k=e):!b&&d&&(g=!0,p=a.tranRes,k=d);g&&c&&c.audio&&"en"===k.srcLang.toLowerCase()&&(k.audio=c.audio);c=g?"translation":"definition";
b||k||(c="none");_gaq&&_gaq.push(["_trackEvent","lookup","type_"+c]);e=encodeURIComponent(a.sanitizedQuery);c="";g&&(c="https://translate.google.com/translate_t?source=dict-chrome-ex&sl="+k.srcLang+"&tl="+q.language+"&q="+e);d="https://www.google.com/search?source=dict-chrome-ex&defl="+q.language+"&hl="+q.language+"&q="+e+"&tbo=1&tbs=dfn:1";"en"===q.language&&(d="https://www.google.com/search?q=define+"+e);if("fetch_html"===a.request.type)b="",b=g?J(p,k.audio,c):K(a.dictRes,d),g={eventKey:a.request.eventKey,
sanitizedQuery:a.sanitizedQuery,html:b};else{var h=null,m=null;g?(h=k,h.moreUrl=c):b&&(h=b,h.moreUrl=d,h.srcLang=q.language);h&&"true"===q.storeHistory&&!a.incognito&&chrome.storage.local.get("word-history",function(b){m=h.srcLang+"<"+q.language+"<"+a.sanitizedQuery;b["word-history"][m]=h.meaningText;chrome.storage.local.set(b)});h&&!h.prettyQuery&&(h.prettyQuery=a.sanitizedQuery);g=!1;("true"===q.popupDblclick&&"none"===q.popupDblclickKey||"true"===q.popupSelect&&"none"===q.popupSelectKey)&&y(a.sanitizedQuery)&&
(g=!0);g={eventKey:a.request.eventKey,sanitizedQuery:a.sanitizedQuery,meaningObj:h,showOptionsTip:g}}a.callback(g)}},I=function(a,b){if(!a||a.sentences[0].orig.toLowerCase()==a.sentences[0].trans.toLowerCase())return null;var c=a.sentences[0].orig.toLowerCase();var d=a.sentences[0].trans.toLowerCase(),e=d;if(b&&a.dict&&0<a.dict.length){b=0;for(var n=a.dict.length;b<n;b++)for(var g=a.dict[b],p=0,k=0,h=g.terms.length;k<h&&2>p;k++){var m=g.terms[k].toLowerCase();0<m.length&&m!==c&&m!==d&&(e+=", "+m,
p++)}}c=w(e);(d=window["gdx.LANG_TO_NAME"][a.src.toLowerCase()])||(d=a.src);return{type:"translation",meaningText:c,attribution:"Translated from "+d,srcLang:a.src}},G=function(a,b){b=b.split(".");for(var c=0;c<b.length;c++){var d=b[c];console.assert(d);if("]"===d.charAt(d.length-1)){d=d.split("[");console.assert(2===d.length);var e=parseInt(d[1].slice(0,-1),10);a=a[d[0]];if(!a)return null;a=a[e]}else a=a[d];if(!a)return null}return a},L=function(a){return"//"===a.substr(0,2)?"https:"+a:a},H=function(a){if(!a||
a.error)return null;var b,c=null;if(b=G(a,"entries[0]"))c={prettyQuery:b.syllabifiedHeadword||b.headword,meaningText:G(b,"senseFamilies[0].senses[0].definition.text"),attribution:"",audio:G(b,"phonetics[0].oxfordAudio"),type:"licensedDef"},c.meaningText?c.audio&&(c.audio=L(c.audio)):c=null;!c&&(b=G(a,"webDefinitions[0]"))&&(c=b.sourceUrl,c={meaningText:b.definition,attribution:'<a href="'+c+'">'+c+"</a>",type:"webDef"});if(!c)return null;b=c.meaningText;c.meaningText=b.charAt(0).toUpperCase()+b.slice(1);
return c},J=function(a,b,c){var d=I(a,!1);if(!d)return"";b&&(d.audio=b);a.tranResSummary=d;a.moreUrl=c;a.hasDict=!!a.dict&&a.dict.length;return r.browser_action_tran(a)},K=function(a,b){if(!a||a.error)return"";a.moreUrl=b;a.makeAudioUrl=function(){var a=this.oxfordAudio;return a?L(a):""};var c={};a.showOnlyOnce=function(){return function(a,b){a=b(a);if(c[a])return"";c[a]=!0;return a}};return r.browser_action_dict(a)},M=function(a){var b={};b.language=a.language||"en";var c=function(c,d){var e=a[c];
b[c]=d;"true"===e||"false"===e?b[c]=e:"boolean"===typeof e&&(b[c]=String(e))},d=function(c,d){b[c]=a[c]||d};c("popupDblclick","true");c("popupSelect","false");c("enableHttps","true");d("popupDblclickKey","none");d("popupSelectKey","ctrl");c("storeHistory","false");c("allowCrossExtensionHistory","false");"pt"===a.language&&(b.language="pt-BR");return b},N=function(a,b,c){if("false"===q.allowCrossExtensionHistory||"false"===q.storeHistory||!a||!a.getHistory)return!1;chrome.storage.local.get("word-history",
function(a){c(a["word-history"])});return!0},O=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0);c.onload=function(){var a=null;200===this.status&&(a=c.response);return b(a)};c.send()},P=function(){var a=window.localStorage.options,b={};a&&(b=JSON.parse(a));q=M(b);window.localStorage.options=JSON.stringify(q);chrome.storage.local.get("word-history",function(a){a["word-history"]||chrome.storage.local.set({"word-history":{}})});chrome.runtime.onMessage.addListener(z);chrome.runtime.onMessage.addListener(A);
chrome.runtime.onMessage.addListener(B);chrome.runtime.onMessage.addListener(F);chrome.runtime.onMessageExternal.addListener(N)};window["gdx.updateOptions"]=function(){q=JSON.parse(window.localStorage.options)};
window.initBackgroundPageAsync=function(a){gapi.client.setApiKey("AIzaSyC9PDwo2wgENKuI8DSFOfqFqKP2cKAxxso");var b=function(){2>Object.keys(r).length||(l=!0,a&&a())},c=function(a){Mustache.parse(a);return function(b){return Mustache.render(a,b)}};O("templates/browser_action_dict.html",function(a){r.browser_action_dict=c(a);b()});O("templates/browser_action_tran.html",function(a){r.browser_action_tran=c(a);b()})};window.initBackgroundPage=P;var Q=Q||!1;Q||P();})();
