(function(b){b.fn.numeric=function(a,d){"boolean"===typeof a&&(a={h:a});a=a||{};"undefined"==typeof a.i&&(a.i=!0);var l=!1===a.h?"":a.h||".",c=!0===a.i?!0:!1;d="function"==typeof d?d:function(){};return this.data("numeric.decimal",l).data("numeric.negative",c).data("numeric.callback",d).keypress(b.fn.numeric.keypress).keyup(b.fn.numeric.keyup).blur(b.fn.numeric.blur)};b.fn.numeric.keypress=function(a){var d=b.data(this,"numeric.decimal"),l=b.data(this,"numeric.negative"),c=a.charCode?a.charCode:a.keyCode?
a.keyCode:0;if(13==c&&"input"==this.nodeName.toLowerCase())return!0;if(13==c)return!1;var e=!1;if(a.ctrlKey&&97==c||a.ctrlKey&&65==c||a.ctrlKey&&120==c||a.ctrlKey&&88==c||a.ctrlKey&&99==c||a.ctrlKey&&67==c||a.ctrlKey&&122==c||a.ctrlKey&&90==c||a.ctrlKey&&118==c||a.ctrlKey&&86==c||a.shiftKey&&45==c)return!0;if(48>c||57<c){var h=b(this).val();if(0!==h.indexOf("-")&&l&&45==c&&(!h.length||!parseInt(b.fn.m(this),10)))return!0;d&&c==d.charCodeAt(0)&&-1!=h.indexOf(d)&&(e=!1);8!=c&&9!=c&&13!=c&&35!=c&&36!=
c&&37!=c&&39!=c&&46!=c?e=!1:"undefined"!=typeof a.charCode&&(a.keyCode==a.which&&0!==a.which?(e=!0,46==a.which&&(e=!1)):0!==a.keyCode&&0===a.charCode&&0===a.which&&(e=!0));d&&c==d.charCodeAt(0)&&(e=-1==h.indexOf(d)?!0:!1)}else e=!0;return e};b.fn.numeric.keyup=function(){var a=b(this).val();if(a&&0<a.length){var d=b.data(this,"numeric.decimal"),l=b.data(this,"numeric.negative");if(""!==d&&null!==d){var c=a.indexOf(d);0===c&&(this.value="0"+a);1==c&&"-"==a.charAt(0)&&(this.value="-0"+a.substring(1));
a=this.value}for(var e=[0,1,2,3,4,5,6,7,8,9,"-",d],c=a.length,h=c-1;0<=h;h--){var m=a.charAt(h);h&&"-"==m?a=a.substring(0,h)+a.substring(h+1):h||l||"-"!=m||(a=a.substring(1));for(var y=!1,p=0;p<e.length;p++)if(m==e[p]){y=!0;break}y&&" "!=m||(a=a.substring(0,h)+a.substring(h+1))}l=a.indexOf(d);if(0<l)for(--c;c>l;c--)a.charAt(c)==d&&(a=a.substring(0,c)+a.substring(c+1));this.value=a}};b.fn.numeric.blur=function(){function a(a){if(a.max&&parseInt(a.value)>parseInt(a.max))a.value=a.max;else if(a.min)a.value=
a.min;else return;b(a).change()}var d=b.data(this,"numeric.decimal"),l=b.data(this,"numeric.callback"),c=this.value;""!==c?(new RegExp("^\\d+$|^\\d*"+d+"\\d+$")).exec(c)&&this.validity.valid||(a(this),l.apply(this)):(a(this),l.apply(this))};b.fn.o=function(){return this.data("numeric.decimal",null).data("numeric.negative",null).data("numeric.callback",null).unbind("keypress",b.fn.numeric.keypress).unbind("blur",b.fn.numeric.blur)}})(jQuery);window._gaq=window._gaq||[];window._gaq.push(["_setAccount","UA-32450437-3"],["_setDetectFlash",!1],["_setDetectTitle",!1],["_trackPageview"]);window.addEventListener("load",function(){var b=document.createElement("script");b.type="text/javascript";b.async=!0;b.src="https://ssl.google-analytics.com/ga.js";document.body.appendChild(b)});var q=localStorage;function C(){chrome.runtime.sendMessage({cmd:"naming_list"},function(b){if(b&&b.list){for(var a="",d=0,l=b.list.length;d<l;++d)a+='<option value="'+b.list[d]+'">';document.getElementById("naming_history").innerHTML=a}})}function D(b){b.bind("keydown.escape_focus",function(a){27==a.keyCode&&$(this).blur()})}function E(b){var a=b.data("_t_err");void 0==a?b.addClass("is-invalid"):clearTimeout(a);b.data("_t_err",setTimeout(function(){b.removeClass("is-invalid");b.removeData("_t_err")},1E3))};var F=chrome.i18n.getMessage;
function H(){function b(a,b){for(var d="i18n-"+a,c=document.querySelectorAll("["+d+"]"),e=0;e<c.length;++e){var h=F(c[e].attributes[d].value);c[e][b]=h;c[e].removeAttribute(d)}}b("text","innerText");b("title","title");b("href","href");b("placeholder","placeholder");(function(a,b){for(var d="i18n-"+a,c=document.querySelectorAll("["+d+"]"),e=0;e<c.length;++e){var h=F(c[e].attributes[d].value);c[e].setAttribute(b,h);c[e].removeAttribute(d)}})("tooltip","data-tooltip");(function(a,b){for(var d="i18n-"+
a,c=document.querySelectorAll("["+d+"]"),e=0;e<c.length;++e){var h=c[e].attributes[d].value.split(","),m=h[0];h.shift();h=F(m,h);c[e][b]=h;c[e].removeAttribute(d)}})("textparams","innerText");"undefined"!=typeof bg_settings&&I()}
function I(){var b=bg_settings.get("font_size");document.documentElement.classList.contains("fs-none")||(document.documentElement.style.fontSize&&document.documentElement.classList.remove("fs-"+document.documentElement.style.fontSize),document.documentElement.style.fontSize=b+"px",document.documentElement.classList.add("fs-"+b+"px"))};var J=["",[String.fromCharCode(103),String.fromCharCode(108),String.fromCharCode(99)].join(""),"1_"].join("_");function K(){var b;b=void 0;var a=q[J+"fe_us"];if(void 0!=a)try{b=JSON.parse(atob(a[1]+a.substr(3)))}catch(d){}a=Date.now();return!b||!b._t||isNaN(b._t)||!isFinite(b._t)||6048E5<a-b._t?{_t:a}:b}
function L(b){var a;a=a||1;var d=K();b=function(a){return btoa(a.split("").map(function(a){var b=a.charCodeAt(0),c=0;"_"!=a&&(c=60<b?-55:53);return String.fromCharCode(b+c)}).join(""))}(b)+"";d[b]=(d[b]||0)+a;(function(a,b){var c=btoa(JSON.stringify(b));q[J+a]=String.fromCharCode(97+Math.floor(26*Math.random()))+c[0]+String.fromCharCode(97+Math.floor(26*Math.random()))+c.substr(1)})("fe_us",d)};document.oncontextmenu=function(b){var a=b.target.nodeName.toLowerCase(),d=b.target.type&&b.target.type.toLowerCase();if(!b.target.classList.contains("allow-ctx-menu")&&(b.target.disabled||"textarea"!=a&&("input"!=a||"text"!=d&&"number"!=d)))return!1};
document.addEventListener("DOMContentLoaded",function(){function b(a){return(a=(new RegExp("[\\?&]"+a+"=([^&#]*)")).exec(location.href))?a[1]:void 0}function a(a){return a?a.trim():""}function d(a){a=a||"";var f=0==a.indexOf("data:"),b=a.indexOf("\r");-1==b&&(b=a.indexOf("\n"));-1!=b?a=a.substr(0,f?Math.min(b,1024):b):f&&1024<a.length&&(a=a.substr(0,1024));return f?M.test(a):N.test(a)}function l(a,b,c){t&&(clearTimeout(t),t=void 0);z.text(a);a&&c?z.addClass(c):z.removeClass();b&&(t=setTimeout(function(){z.text("").removeClass();
t=void 0},b))}function c(f){var b=k.find("form").l(),c=(b.naming||"").trim().replace(/(^(\\|\/|\.)+)|((\\|\/|\.)+$)/g,"").replace(/\s*(\\|\/)+\s*/g,"/").trim();if((c?c.length-c.replace(/\*/g,"").length:0)&1)return A.val(c),E(A),l(F("errorInvalidNamingMask"),2E3),!1;c.indexOf("*")!=c.lastIndexOf("*")&&L("naming_mask");f=1==f;for(var w=[],x=b.url.split("\r\n"),g=a(b.referer),e=a(b.desc),h=a(b.text),r=a(b.title),m="on"==b.addtop||"checked"==b.addtop||"yes"==b.addtop,v="",B=0,O=x.length;B<O;++B){var u=
a(x[B]).replace(/ /g,"%20");if(u){var t=P(u);if(t)if(d(u.replace(/\[[^\[\]]*\]/g,""))){if(!confirm(y(t))||""!=b.naming&&-1==b.naming.indexOf("*")&&!confirm(F("confirmBatchDownloadNaming")))return!1;p(t,"",0,function(a){w.push({url:a,folder:"",naming:c,referer:g,desc:e,threads:0})});L("batch_desc")}else v+=u+"\n";else d(u)?w.push({url:u,folder:"",naming:c,referer:g,desc:e,text:h,title:r,threads:0}):v+=u+"\n"}}b=!0;if(w&&0<w.length)try{x=!1;try{x="chrome-extension:"==window.top.location.protocol}catch(G){}chrome.runtime.sendMessage({cmd:"new_task",
add_paused:f,addtop:m,tasks:w,page_title:Q,source:"dialog_"+(x?"chrono":"others")},function(a){a||l(chrome.runtime.lastError,2E3)})}catch(G){l(G,2E3),b=!1}else b=!1;v&&(b=!1,v=a(v),n.val(v),E(n),l(F("errorInvalidURLs"),2E3));return b}function e(a,b){a||(a={url:"",referer:"",desc:""});if("<clipboard>"==a.url)l(F("statusReadClipboard"),0,"info"),setTimeout(function(){var c=$("<textarea/>");c.appendTo($("body")).focus();document.execCommand("paste");var f=c.val();c.remove();c=f.trim().replace(/ /g,"%20");
a.url=c&&d(c)?c:"";l("");e(a,b)},100);else{b&&b.fontSize&&(document.body.style.fontSize=b.fontSize+"px");C();var c=n.val();c?a.url&&(n.val(c+"\n"+a.url),n[0].style.height||n.attr("rows",""+Math.min(4,parseInt(n.attr("rows")||"1")+1))):(n.val(a.url),-1==a.url.indexOf("\n")&&-1==a.url.indexOf("\r")||n.attr("rows","2"),k.find("[name=referer]").val(a.referer),k.find("[name=desc]").val(a.desc),a.text&&k.find("[name=text]").val(a.text),a.title&&k.find("[name=title]").val(a.title),k.find("[name=addtop]").prop("checked",
!1),(c=b?b.taskDef:null)&&c.addtop&&k.find("[name=addtop]").prop("checked",!0));a&&a.url?A.focus():n.focus()}}function h(){k.addClass("transparent");n.val("").attr("rows","1")[0].style.height="";setTimeout(function(){window.parent.postMessage({cmd:"close_dlg",id:R},"*");k.removeClass("transparent")},400)}function m(){k.find(".page").addClass("pulse");k.find(".page").on("webkitAnimationEnd",function(){$(this).removeClass("pulse")})}function y(a){var b=F("confirmBatchDownload")+"\n",c="",f=3,d=2,g=
f+d+1;p(a,"",0,function(a){0<f--&&(c+=a+"\n");return 0<--g});if(g-1<d){var e="",d=d-Math.max(g-1,0),h={a:[]};h.c=a.c;for(var r=0;r<a.a.length;++r){var k=a.a[r].from,l=a.a[r].b,n=a.a[r].step,m=k;if(0<n)for(;m<=l;m+=n);else for(;m>=l;m+=n);m-=n;h.a.push({from:m,b:k,step:-n,f:a.a[r].f,padding:a.a[r].padding,g:a.a[r].g})}p(h,"",0,function(a){e=a+"\n"+e;return 0<--d});0>=g&&(c+="...\n");c+=e}a.stop=!1;return b=b+c+("\n"+F("confirmProceed"))}function p(a,b,c,d){if(a&&!a.stop)if(c<a.c.length&&(b+=a.c[c]),
c>=a.c.length-1)0==d(b)&&(a.stop=!0);else{var f=a.a[c];if(0<f.step)if(f.f)for(var g=f.from;g<=f.b;g+=f.step)p(a,b+String.fromCharCode(g),c+1,d);else if(f.padding)for(g=f.from;g<=f.b;g+=f.step){var e=Math.abs(g).toString();p(a,b+(0>g?"-":"")+(f.g+e).slice(-Math.max(f.padding,e.length)),c+1,d)}else for(g=f.from;g<=f.b;g+=f.step)p(a,b+g,c+1,d);else if(f.f)for(g=f.from;g>=f.b;g+=f.step)p(a,b+String.fromCharCode(g),c+1,d);else if(f.padding)for(g=f.from;g>=f.b;g+=f.step)e=Math.abs(g).toString(),p(a,b+(0>
g?"-":"")+(f.g+e).slice(-Math.max(f.padding,e.length)),c+1,d);else for(g=f.from;g>=f.b;g+=f.step)p(a,b+g,c+1,d)}}function P(a){function b(a){return"0"==a[0]&&1<a.length||"-"==a[0]&&"0"==a[1]&&2<a.length}if(-1!=a.indexOf("\x00\x00"))return null;var c={c:[],a:[],stop:!1};a=a.replace(/\[((?:-)?\d+|[a-z]):((?:-)?\d+|[a-z])(?::((?:-)?\d+))?\]/gi,function(a,f,d,e){var h=0;if(void 0!=e&&(h=parseInt(e),isNaN(h)||!isFinite(h)))return a;e=f.charCodeAt(0);var g=d.charCodeAt(0);if(65<=e&&90>=e&&65<=g&&90>=g||
97<=e&&122>=e&&97<=g&&122>=g){if(h=h||(0>g-e?-1:1),g==e||0>g-e==0>h)return c.a.push({f:!0,from:e,b:g,step:h}),"\x00\x00"}else{e=parseInt(f,10);g=parseInt(d,10);if(isNaN(e)||isNaN(g))return a;h=h||(0>g-e?-1:1);if(g==e||0>g-e==0>h){a={f:!1,from:e,b:g,step:h};b(f)?(f=f.length-("-"==f[0]),a.padding=b(d)?Math.max(f,d.length-("-"==d[0])):f):b(d)&&(a.padding=d.length-("-"==d[0]));if(a.padding)for(a.g=Array(a.padding+1).join("0"),a.j=1,d=0;d<a.padding;++d)a.j*=10;c.a.push(a);return"\x00\x00"}}return a});
return c.a.length?(c.c=a.split("\x00\x00"),c):null}$.fn.l=function(){var a={};$.each(this.serializeArray(),function(){void 0!==a[this.name]?(a[this.name].push||(a[this.name]=[a[this.name]]),a[this.name].push(this.value||"")):a[this.name]=this.value||""});return a};var M=/^data:([^;]+)((?:;[^=]+=[^;]+)*)(?:;(base64))?,(.+)$/,N=RegExp("^(?:(?:https?|ftp)://)?(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))\\.?)(?::\\d{2,5})?(?:[/?#]\\S*)?$",
"i"),R=b("id"),S="1"==b("native"),Q=decodeURIComponent((b("page_title")||"").replace(/\+/g," ")),k=$(".overlay"),n=k.find("[name=url]"),A=k.find("[name=naming]"),t,z=$("#error_msg");window.addEventListener("message",function(a){"init"==a.data.cmd&&e(a.data.task,a.data.dlg_opts)},!1);H();S||$(".native_only").remove();A.attr("placeholder",F("phraseAutomatic"));k.find("input[type=number]").numeric({h:!1,i:!1});$(document).bind("keydown.dydlg",function(a){switch(a.keyCode){case 27:a.target==document.body&&
h();break;case 70:case 71:case 79:case 83:if(a.ctrlKey||a.metaKey)return!1}});D(k.find("input, textarea"));k.find(".dlg_cancel_btn, .close-button").click(function(){h()});k.find(".dlg_start_btn").click(function(){c()&&h()});k.find(".dlg_apause_btn").click(function(){c(!0)&&h()});k.find("#tip-batch_desc").click(function(){chrome.runtime.sendMessage({cmd:"open_options",section:"help.batch_desc"})});k.find("#tip-naming_mask").click(function(){chrome.runtime.sendMessage({cmd:"open_options",section:"help.naming_mask"})});
k.click(function(a){a:{a=a.target;for(var b=k.find(".page")[0],c=document.body;a&&c!=a;){if(a==b){a=!0;break a}a=a.parentNode}a=!1}a||m()});window.addEventListener("dragover",function(a){var b=a.target.nodeName.toLowerCase();("input"!=b&&"textarea"!=b||a.target.disabled)&&a.preventDefault()},!1);window.addEventListener("drop",function(a){var b=a.target.nodeName.toLowerCase();if("input"!=b&&"textarea"!=b||a.target.disabled)b=a.dataTransfer.getData("text/plain").replace(/ /g,"%20"),d(b)&&(e({url:b},
null),a.preventDefault())},!1)});
